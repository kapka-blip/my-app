<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì¼ ì‹ë‹¨ ìë™ ê³„ì‚°ê¸°</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        /* ìˆ«ì ì…ë ¥ í•„ë“œì—ì„œ í™”ì‚´í‘œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-4xl">
        
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">
            ì¼ì¼ ì‹ë‹¨ ìë™ ê³„ì‚°ê¸°
        </h1>
        <!-- âš ï¸ Firebase ì„¤ì •ì´ ì—†ìœ¼ë©´ ì´ ë©”ì‹œì§€ê°€ ìœ ì§€ë©ë‹ˆë‹¤. -->
        <p id="user-info" class="text-xs text-center text-gray-500 mb-6">[ì‚¬ìš©ì ì¸ì¦ ì¤‘...]</p>
        
        <!-- 1. ì´ í•©ê³„ í‘œì‹œ ì˜ì—­ -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-blue-600 mb-1">ì´ ì¹¼ë¡œë¦¬ (Kcal)</div>
                <div id="total-kcal" class="text-2xl font-bold text-blue-800">0</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-green-600 mb-1">ì´ íƒ„ìˆ˜í™”ë¬¼ (g)</div>
                <div id="total-carbs" class="text-2xl font-bold text-green-800">0</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-red-600 mb-1">ì´ ë‹¨ë°±ì§ˆ (g)</div>
                <div id="total-protein" class="text-2xl font-bold text-red-800">0</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-yellow-600 mb-1">ì´ ì§€ë°© (g)</div>
                <div id="total-fat" class="text-2xl font-bold text-yellow-800">0</div>
            </div>
        </div>

        <!-- 2. ì‹ë‹¨ ì…ë ¥ í¼ -->
        <form id="meal-form" class="space-y-4 sm:space-y-0 sm:flex sm:items-end sm:space-x-4">
            <!-- ë‚ ì§œ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 140px;">
                <label for="meal-date" class="block text-sm font-medium text-gray-700">ë‚ ì§œ</label>
                <input type="date" id="meal-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- ì‹ë‹¨ëª… ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 200px;">
                <label for="meal-name" class="block text-sm font-medium text-gray-700">ì‹ë‹¨ëª…</label>
                <input type="text" id="meal-name" placeholder="ì˜ˆ: ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- ì¹¼ë¡œë¦¬ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="kcal" class="block text-sm font-medium text-gray-700">Kcal</label>
                <input type="number" id="kcal" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- íƒ„ìˆ˜í™”ë¬¼ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="carbs" class="block text-sm font-medium text-gray-700">íƒ„ìˆ˜í™”ë¬¼(g)</label>
                <input type="number" id="carbs" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- ë‹¨ë°±ì§ˆ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="protein" class="block text-sm font-medium text-gray-700">ë‹¨ë°±ì§ˆ(g)</label>
                <input type="number" id="protein" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- ì§€ë°© ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="fat" class="block text-sm font-medium text-gray-700">ì§€ë°©(g)</label>
                <input type="number" id="fat" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- ì¶”ê°€/ì €ì¥ ë²„íŠ¼ -->
            <button type="submit" id="submit-button" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ì¶”ê°€
            </button>
        </form>

        <!-- ìµœì¢… ì €ì¥ ë²„íŠ¼ -->
        <!-- Firebase ì„¤ì • ì˜¤ë¥˜ ì‹œ ì´ ë²„íŠ¼ì€ í´ë¼ìš°ë“œ ì €ì¥ì„ ì‹œë„í•˜ë¯€ë¡œ ê³„ì† ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. -->
        <button type="button" onclick="saveDailyRecord()" class="mt-4 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ìµœì¢… ì €ì¥ (í´ë¼ìš°ë“œ)
        </button>


        <!-- 3. ì¶”ê°€ëœ ì‹ë‹¨ ëª©ë¡ -->
        <h2 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">ì˜¤ëŠ˜ì˜ ì‹ë‹¨ (ë¯¸ì €ì¥, ë¡œì»¬ì— ì„ì‹œ ë³´ê´€ ì¤‘)</h2>
        <div class="overflow-x-auto mb-10">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚ ì§œ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‹ë‹¨ëª…</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">íƒ„ìˆ˜í™”ë¬¼ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ë‹¨ë°±ì§ˆ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ë°© (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="meal-list" class="bg-white divide-y divide-gray-200">
                    <tr id="initial-example" class="opacity-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic">ì˜ˆ: 10ì›” 31ì¼</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic">ì˜ˆ: ìŠ¬ë¦¼ì¿¡ ëª©ì‚´ ìŠ¤í…Œì´í¬</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">355</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">29</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">17</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">21</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 4. ë‚ ì§œë³„ ì €ì¥ ê¸°ë¡ -->
        <h2 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">ë‚ ì§œë³„ ì €ì¥ ê¸°ë¡ (ì´í•©ê³„)</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚ ì§œ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">íƒ„ìˆ˜í™”ë¬¼ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ë‹¨ë°±ì§ˆ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ë°© (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒì„¸</th>
                    </tr>
                </thead>
                <tbody id="daily-records-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">ì €ì¥ëœ ì¼ì¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (í´ë¼ìš°ë“œ)</td>
                    </tr>
                </tbody>
            </table>
        </div>


    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { QueryConstraint, limit, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // orderBy ì¶”ê°€

        // --- 0. ì „ì—­ ì„¤ì • ë° ë³€ìˆ˜ ì„ ì–¸ ---

        // ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ Firebase Config ê°’ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”! 
        const manualFirebaseConfig = {
              apiKey: "AIzaSyCjyTrnhFuGV8PVD3mtMj9ZD7DFX4J3s",
              authDomain: "meal-tracker-f2644.firebaseapp.com",
              projectId: "meal-tracker-f2644",
              storageBucket: "meal-tracker-f2644.appspot.com",
              messagingSenderId: "739384992411",
              appId: "1:739384992411:web:1e47f734197cd6dff89c3e"
            };

        // Firebase ì „ì—­ ë³€ìˆ˜ (GitHub Pages í™˜ê²½ì„ ìœ„í•œ ìˆ˜ë™ ì„¤ì •)
        const __app_id = 'diet_calculator'; 
        const __firebase_config = JSON.stringify(manualFirebaseConfig);
        const __initial_auth_token = ''; // GitHub Pagesì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹ˆ ë¬¸ìì—´ë¡œ ë‘¡ë‹ˆë‹¤.

        let db = null;
        let auth = null;
        let isCloudEnabled = false;
        let userId = 'local-anonymous-user-' + crypto.randomUUID(); // í´ë¼ìš°ë“œ ë¹„í™œì„±í™” ì‹œ ì‚¬ìš©ë  ì„ì‹œ ID

        // UI ìš”ì†Œ
        const mealInput = {
            date: document.getElementById('meal-date'),
            name: document.getElementById('meal-name'),
            kcal: document.getElementById('meal-kcal'),
            carbs: document.getElementById('meal-carbs'),
            protein: document.getElementById('meal-protein'),
            fat: document.getElementById('meal-fat'),
            addButton: document.getElementById('add-meal')
        };
        const summary = {
            kcal: document.getElementById('summary-kcal'),
            carbs: document.getElementById('summary-carbs'),
            protein: document.getElementById('summary-protein'),
            fat: document.getElementById('summary-fat')
        };
        const statusMessage = document.getElementById('status-message');
        const mealList = document.getElementById('meal-list');
        const totalRecordList = document.getElementById('total-record-list');
        const saveButton = document.getElementById('save-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // ìƒíƒœ
        let meals = loadLocalMeals(); // ë¯¸ì €ì¥ ì‹ë‹¨
        let totalRecords = {}; // ë‚ ì§œë³„ ì €ì¥ ê¸°ë¡

        // --- 1. Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---

        function updateStatus(message, isError = false) {
            statusMessage.innerHTML = message;
            statusMessage.className = isError ? 'text-red-600' : 'text-gray-600';
            console.log(`STATUS: ${message}`);
        }

        // Firebaseë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í•µì‹¬ ë¡œì§ (ìˆ˜ì •ë¨)
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                
                // Configê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ í´ë¼ìš°ë“œ ë¹„í™œì„±í™”
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.length < 10) {
                    throw new Error("Missing or invalid Firebase configuration.");
                }

                // Configê°€ ìœ íš¨í•  ê²½ìš°ì—ë§Œ ì´ˆê¸°í™” ì§„í–‰
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì • (ë””ë²„ê¹…ìš©)
                setLogLevel('error'); // ë°°í¬ ì‹œì—ëŠ” 'error'ë¡œ ì„¤ì •í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë¡œê·¸ë¥¼ ì¤„ì…ë‹ˆë‹¤.

                // ìµëª… ì¸ì¦ ë° ì‚¬ìš©ì ìƒíƒœ ê°ì§€
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            // ìµëª… ë¡œê·¸ì¸ ì‹œë„
                            try {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                updateStatus(`ID: ${userId} (í´ë¼ìš°ë“œ ì—°ê²°ë¨)`, false);
                                isCloudEnabled = true;
                            } catch (error) {
                                console.error("Firebase ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                                updateStatus('Firebase ì¸ì¦ ì‹¤íŒ¨. í´ë¼ìš°ë“œ ì €ì¥ ë¹„í™œì„±í™”.', true);
                                isCloudEnabled = false;
                            }
                        } else {
                            userId = user.uid;
                            updateStatus(`ID: ${userId} (í´ë¼ìš°ë“œ ì—°ê²°ë¨)`, false);
                            isCloudEnabled = true;
                        }
                        unsubscribe(); // ì´ˆê¸° ì¸ì¦ í™•ì¸ í›„ ë¦¬ìŠ¤ë„ˆ í•´ì œ
                        resolve();
                    });
                });

                if (isCloudEnabled) {
                    setupCloudListeners();
                }
            } catch (e) {
                console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ:", e);
                updateStatus(`Firebase ì„¤ì • ì˜¤ë¥˜. (ID: ${userId} / í´ë¼ìš°ë“œ ì €ì¥ ë¹„í™œì„±í™”)`, true);
                showErrorModal("Firebase ì—°ê²° ì˜¤ë¥˜", "Firebase ì„¤ì • ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ í´ë¼ìš°ë“œ ë°ì´í„° ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìˆ˜ì ì¸ ê¸°ëŠ¥ì´ë¯€ë¡œ, ë¡œì»¬ ì„ì‹œ ì €ì¥ì†ŒëŠ” ì‘ë™í•©ë‹ˆë‹¤.");
                isCloudEnabled = false;
            }
        }

        // --- 2. ë¡œì»¬ ì €ì¥ì†Œ (Local Storage) ê¸°ëŠ¥ ---
        
        // ... (loadLocalMeals, saveLocalMeals, etc.ëŠ” ë™ì¼)
        function loadLocalMeals() {
            const data = localStorage.getItem('localMeals');
            return data ? JSON.parse(data) : [];
        }

        function saveLocalMeals() {
            localStorage.setItem('localMeals', JSON.stringify(meals));
        }


        // --- 3. í´ë¼ìš°ë“œ ì €ì¥ì†Œ (Firestore) ê¸°ëŠ¥ ---
        
        // Firestore ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ ì„¤ì •
        function getCollectionPath() {
            // Firestore ê·œì¹™ì— ë”°ë¼ ì‚¬ìš©ìë³„ë¡œ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
            return `artifacts/${__app_id}/users/${userId}/meal_records`;
        }

        // Firestore ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupCloudListeners() {
            if (!isCloudEnabled || !db) return;

            // 1. ë‚ ì§œë³„ ì´í•©ê³„ ê¸°ë¡ ë¦¬ìŠ¤ë„ˆ
            const totalQuery = query(collection(db, getCollectionPath()));

            onSnapshot(totalQuery, (snapshot) => {
                loadingIndicator.textContent = "ì €ì¥ëœ ì¼ì¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (í´ë¼ìš°ë“œ)";
                totalRecords = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = doc.id; // ë¬¸ì„œ IDë¥¼ ë‚ ì§œë¡œ ì‚¬ìš©
                    totalRecords[date] = {
                        kcal: data.totalKcal,
                        carbs: data.totalCarbs,
                        protein: data.totalProtein,
                        fat: data.totalFat
                    };
                });
                renderTotalRecords();
                loadingIndicator.textContent = "";
            }, (error) => {
                console.error("í´ë¼ìš°ë“œ ê¸°ë¡ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
                loadingIndicator.textContent = "í´ë¼ìš°ë“œ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ.";
            });
        }


        // ìµœì¢… ì €ì¥ í•¨ìˆ˜ (ë¡œì»¬ -> í´ë¼ìš°ë“œ)
        async function saveTodaysMeals() {
            if (!isCloudEnabled || !db) {
                showErrorModal("ì €ì¥ ë¶ˆê°€", "í´ë¼ìš°ë“œ ì €ì¥ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase ì„¤ì •ì„ ì™„ë£Œí•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
                return;
            }
            
            if (meals.length === 0) {
                showErrorModal("ê²½ê³ ", "ì €ì¥í•  ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                // ë‹¹ì¼ ë‚ ì§œ ê³„ì‚°
                const today = new Date().toISOString().substring(0, 10);
                
                // ì´í•©ê³„ ê³„ì‚°
                const totals = meals.reduce((acc, meal) => {
                    acc.totalKcal += meal.kcal;
                    acc.totalCarbs += meal.carbs;
                    acc.totalProtein += meal.protein;
                    acc.totalFat += meal.fat;
                    return acc;
                }, { totalKcal: 0, totalCarbs: 0, totalProtein: 0, totalFat: 0 });

                // Firestoreì— ë¬¸ì„œ IDë¥¼ ë‚ ì§œë¡œ ì‚¬ìš©í•˜ì—¬ ì €ì¥
                const mealDocRef = doc(db, getCollectionPath(), today);

                await setDoc(mealDocRef, {
                    meals: meals, // ëª¨ë“  ìƒì„¸ ì‹ë‹¨ ê¸°ë¡
                    totalKcal: totals.totalKcal,
                    totalCarbs: totals.totalCarbs,
                    totalProtein: totals.totalProtein,
                    totalFat: totals.totalFat,
                    timestamp: serverTimestamp()
                });

                // ì €ì¥ ì„±ê³µ ì‹œ ë¯¸ì €ì¥ ì‹ë‹¨ ëª©ë¡ ì´ˆê¸°í™”
                meals = [];
                saveLocalMeals();
                renderMeals();
                showErrorModal("ì„±ê³µ", `${today} ì‹ë‹¨ ê¸°ë¡ì´ í´ë¼ìš°ë“œì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (e) {
                console.error("í´ë¼ìš°ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                showErrorModal("ì €ì¥ ì‹¤íŒ¨", "í´ë¼ìš°ë“œì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }
        
        // ìƒì„¸ ê¸°ë¡ ë¡œë“œ í•¨ìˆ˜
        async function loadMealDetails(date) {
            if (!isCloudEnabled || !db) {
                showErrorModal("ì¡°íšŒ ë¶ˆê°€", "í´ë¼ìš°ë“œ ì—°ê²°ì´ í™œì„±í™”ë˜ì§€ ì•Šì•„ ìƒì„¸ ê¸°ë¡ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return [];
            }
            try {
                const docRef = doc(db, getCollectionPath(), date);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    return docSnap.data().meals || [];
                } else {
                    showErrorModal("ì˜¤ë¥˜", `${date}ì˜ ìƒì„¸ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return [];
                }
            } catch (e) {
                console.error("ìƒì„¸ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:", e);
                showErrorModal("ì˜¤ë¥˜", "ìƒì„¸ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                return [];
            }
        }


        // --- 4. ë Œë”ë§ ë° UI ê¸°ëŠ¥ ---

        // ... (addMeal, deleteMeal, renderMeals, renderTotalRecords, etc.ëŠ” ë™ì¼)
        function calculateSummary() {
            const totals = meals.reduce((acc, meal) => {
                acc.kcal += meal.kcal;
                acc.carbs += meal.carbs;
                acc.protein += meal.protein;
                acc.fat += meal.fat;
                return acc;
            }, { kcal: 0, carbs: 0, protein: 0, fat: 0 });

            summary.kcal.textContent = totals.kcal;
            summary.carbs.textContent = totals.carbs;
            summary.protein.textContent = totals.protein;
            summary.fat.textContent = totals.fat;
        }
        
        // ë¯¸ì €ì¥ ì‹ë‹¨ ë Œë”ë§
        function renderMeals() {
            calculateSummary();
            mealList.innerHTML = '';

            if (meals.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="py-4 text-center text-gray-500">ì˜¤ëŠ˜ì˜ ì‹ë‹¨ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</td>`;
                mealList.appendChild(row);
                return;
            }

            meals.forEach((meal, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b text-sm';
                row.innerHTML = `
                    <td class="px-2 py-2">${meal.date}</td>
                    <td class="px-2 py-2">${meal.name}</td>
                    <td class="px-2 py-2">${meal.kcal}</td>
                    <td class="px-2 py-2">${meal.carbs} (G)</td>
                    <td class="px-2 py-2">${meal.protein} (G)</td>
                    <td class="px-2 py-2">${meal.fat} (G)</td>
                    <td class="px-2 py-2 space-x-2 whitespace-nowrap">
                        <button onclick="editMeal(${index})" class="text-blue-500 hover:text-blue-700 text-xs">ìˆ˜ì •</button>
                        <button onclick="deleteMeal(${index})" class="text-red-500 hover:text-red-700 text-xs">ì‚­ì œ</button>
                    </td>
                `;
                mealList.appendChild(row);
            });
            saveLocalMeals();
        }

        // ì €ì¥ëœ ê¸°ë¡ ë Œë”ë§
        function renderTotalRecords() {
            totalRecordList.innerHTML = '';
            const dates = Object.keys(totalRecords).sort().reverse();
            
            if (dates.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" class="py-4 text-center text-gray-500">í´ë¼ìš°ë“œì— ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
                totalRecordList.appendChild(row);
                return;
            }

            dates.forEach((date) => {
                const record = totalRecords[date];
                const row = document.createElement('tr');
                row.className = 'border-b text-sm';
                row.innerHTML = `
                    <td class="px-2 py-2">${date}</td>
                    <td class="px-2 py-2">${record.kcal}</td>
                    <td class="px-2 py-2">${record.carbs} (G)</td>
                    <td class="px-2 py-2">${record.protein} (G)</td>
                    <td class="px-2 py-2">${record.fat} (G)</td>
                    <td class="px-2 py-2 whitespace-nowrap">
                        <button onclick="showDetails('${date}')" class="text-teal-500 hover:text-teal-700 text-xs">ìƒì„¸</button>
                    </td>
                `;
                totalRecordList.appendChild(row);
            });
        }
        
        // ìƒì„¸ ê¸°ë¡ ëª¨ë‹¬ í‘œì‹œ
        async function showDetails(date) {
            const modalBody = document.getElementById('details-modal-body');
            const modalTitle = document.getElementById('details-modal-title');
            
            modalTitle.textContent = `${date} ì‹ë‹¨ ìƒì„¸ ê¸°ë¡`;
            modalBody.innerHTML = `<p class="text-center text-gray-500">ìƒì„¸ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            document.getElementById('details-modal').classList.remove('hidden');

            const details = await loadMealDetails(date);

            if (details.length === 0) {
                 modalBody.innerHTML = `<p class="text-center text-red-500">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ê±°ë‚˜ ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                 return;
            }

            let html = `<table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‹ë‹¨ëª…</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">íƒ„ìˆ˜í™”ë¬¼(G)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‹¨ë°±ì§ˆ(G)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ë°©(G)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;

            details.forEach(meal => {
                html += `<tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.name}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.kcal}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.carbs}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.protein}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.fat}</td>
                         </tr>`;
            });
            
            html += `</tbody></table>`;
            modalBody.innerHTML = html;
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeModal = function() {
            document.getElementById('details-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.add('hidden');
            // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('edit-modal').classList.add('hidden');
        }
        
        // ì˜¤ë¥˜ ëª¨ë‹¬ í‘œì‹œ
        function showErrorModal(title, message) {
            document.getElementById('error-modal-title').textContent = title;
            document.getElementById('error-modal-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        // ì‹ë‹¨ ì¶”ê°€ í•¸ë“¤ëŸ¬
        window.addMeal = function() {
            const meal = {
                date: mealInput.date.value,
                name: mealInput.name.value.trim(),
                kcal: parseInt(mealInput.kcal.value) || 0,
                carbs: parseInt(mealInput.carbs.value) || 0,
                protein: parseInt(mealInput.protein.value) || 0,
                fat: parseInt(mealInput.fat.value) || 0,
            };

            if (!meal.name || meal.kcal <= 0) {
                showErrorModal("ì…ë ¥ ì˜¤ë¥˜", "ì‹ë‹¨ëª…ê³¼ 0 ì´ìƒì˜ ì¹¼ë¡œë¦¬(Kcal)ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
                return;
            }

            meals.push(meal);
            renderMeals();
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            mealInput.name.value = '';
            mealInput.kcal.value = '';
            mealInput.carbs.value = '';
            mealInput.protein.value = '';
            mealInput.fat.value = '';
            mealInput.name.focus();
        };
        
        // ì‹ë‹¨ ì‚­ì œ í•¸ë“¤ëŸ¬
        window.deleteMeal = function(index) {
            meals.splice(index, 1);
            renderMeals();
        };

        // ì‹ë‹¨ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        window.editMeal = function(index) {
            const meal = meals[index];
            document.getElementById('edit-meal-name').value = meal.name;
            document.getElementById('edit-meal-kcal').value = meal.kcal;
            document.getElementById('edit-meal-carbs').value = meal.carbs;
            document.getElementById('edit-meal-protein').value = meal.protein;
            document.getElementById('edit-meal-fat').value = meal.fat;
            document.getElementById('edit-modal-save').onclick = () => saveEdit(index);
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        
        // ì‹ë‹¨ ìˆ˜ì • ì €ì¥
        window.saveEdit = function(index) {
            const name = document.getElementById('edit-meal-name').value.trim();
            const kcal = parseInt(document.getElementById('edit-meal-kcal').value) || 0;
            const carbs = parseInt(document.getElementById('edit-meal-carbs').value) || 0;
            const protein = parseInt(document.getElementById('edit-meal-protein').value) || 0;
            const fat = parseInt(document.getElementById('edit-meal-fat').value) || 0;

            if (!name || kcal <= 0) {
                showErrorModal("ì…ë ¥ ì˜¤ë¥˜", "ì‹ë‹¨ëª…ê³¼ 0 ì´ìƒì˜ ì¹¼ë¡œë¦¬(Kcal)ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.");
                return;
            }

            meals[index] = { ...meals[index], name, kcal, carbs, protein, fat };
            renderMeals();
            document.getElementById('edit-modal').classList.add('hidden');
        }


        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.onload = function() {
            // ë‚ ì§œ ì…ë ¥ í•„ë“œì˜ ê¸°ë³¸ê°’ì„ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
            const today = new Date().toISOString().substring(0, 10);
            mealInput.date.value = today;

            mealInput.addButton.addEventListener('click', window.addMeal);
            saveButton.addEventListener('click', saveTodaysMeals);
            
            // ì´ˆê¸° ë Œë”ë§ ë° Firebase ì´ˆê¸°í™”
            renderMeals();
            initializeFirebase();
        };

        // ì „ì—­ìœ¼ë¡œ í•„ìš”í•œ í•¨ìˆ˜ ë…¸ì¶œ
        window.showDetails = showDetails;
        window.loadMealDetails = loadMealDetails;

    </script>


</body>
</html>
