<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일일 식단 자동 계산기</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        // 1. 필요한 함수 임포트 (Firebase SDK 11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, getDocs, setLogLevel, where, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCjTyTrnhFuGV8PVd3mtMj9zQd7DFX4J3s",
            authDomain: "meal-tracker-f2644.firebaseapp.com",
            projectId: "meal-tracker-f2644",
            storageBucket: "meal-tracker-f2644.appspot.com", 
            messagingSenderId: "739384992411",
            appId: "1:739384992411:web:1e47f734197cd6dff89c3e"
        };
        
        // 3. 변수 초기화 (URL에서 auth_token 읽어오기)
        const appId = firebaseConfig.projectId; 
        
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        const initialAuthToken = getQueryParam('auth_token');

        let app, db, auth, userId = null;

        // 4. 전역 함수로 노출
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.setLogLevel = setLogLevel;
        window.setPersistence = setPersistence;
        window.browserSessionPersistence = browserSessionPersistence;
        window.where = where;
        window.documentId = documentId;
        
        // 5. 인스턴스/설정 반환 함수
        window.getFirebaseInstances = () => ({ app, db, auth, userId, appId, initialAuthToken, config: firebaseConfig });
        window.setUserId = (id) => { userId = id; };
    </script>
    
    <style>
        /* (스타일은 기존과 동일) */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        #report-content::-webkit-scrollbar {
            width: 8px;
        }
        #report-content::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }
        #report-content::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-4xl">
        
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-4">
            일일 식단 자동 계산기
        </h1>

        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-daily-input" onclick="switchView('daily-input')"
                    class="px-4 py-2 text-sm sm:text-base font-medium rounded-t-lg transition-colors duration-150 border-b-2 border-indigo-500 text-indigo-600">
                일일 입력
            </button>
            <button id="tab-report" onclick="switchView('report')"
                    class="px-4 py-2 text-sm sm:text-base font-medium rounded-t-lg transition-colors duration-150 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-500">
                저장 기록 조회
            </button>
        </div>

        <div id="auth-status-message" class="text-center p-3 mb-4 rounded-lg text-sm transition-opacity duration-300 bg-red-100 text-red-600">
            데이터베이스 연결 중...
        </div>
        
        <div id="view-container">
            
            <div id="daily-input-view" class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 rounded-xl shadow-inner">
                    <div class="mb-2 sm:mb-0">
                        <label for="meal-date" class="block text-sm font-medium text-gray-700 mb-1">날짜 선택:</label>
                        <input type="date" id="meal-date" class="p-2 border border-gray-300 rounded-lg w-full sm:w-auto shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="text-xs text-gray-500 text-right w-full sm:w-auto">
                        <span class="font-semibold">사용자 ID (공유 가능):</span>
                        <p id="user-id-display" class="break-all mt-1"></p>
                    </div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-indigo-800 mb-4">식단 입력</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-6 gap-3">
                        <input type="text" id="meal-name" placeholder="식단명 (예: 아침 식사)" class="col-span-2 p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md" required>
                        <input type="number" id="meal-kcal" placeholder="Kcal" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md" required>
                        <input type="number" id="meal-carbs" placeholder="탄수화물(g)" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md">
                        <input type="number" id="meal-protein" placeholder="단백질(g)" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md">
                        <input type="number" id="meal-fat" placeholder="지방(g)" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md">
                    </div>
                    <button id="add-meal-button"
                            class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition-colors duration-200 font-bold shadow-lg transform hover:scale-[1.01]">
                        + 식단 추가
                    </button>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">오늘의 식단 목록</h2>
                    <div id="meals-list" class="space-y-3">
                        <p class="text-gray-500 text-center p-4" id="no-meals-message">추가된 식단이 없습니다.</p>
                    </div>

                    <div id="totals" class="bg-green-50 p-4 rounded-xl shadow-md border-l-4 border-green-500 font-semibold text-green-800">
                        <h3 class="text-lg mb-2">총 합계</h3>
                        <div class="grid grid-cols-4 gap-2 text-sm">
                            <p>Kcal: <span id="total-kcal">0</span></p>
                            <p>탄수화물(g): <span id="total-carbs">0</span></p>
                            <p>단백질(g): <span id="total-protein">0</span></p>
                            <p>지방(g): <span id="total-fat">0</span></p>
                        </div>
                    </div>

                    <button id="save-button"
                            class="w-full bg-green-600 text-white py-3 rounded-xl hover:bg-green-700 transition-colors duration-200 font-bold shadow-lg transform hover:scale-[1.01]">
                        오늘의 식단 저장
                    </button>
                </div>
            </div>

            <div id="report-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">식단 저장 기록</h2>
                
                <div class="bg-yellow-50 p-4 rounded-xl shadow-inner border-l-4 border-yellow-500">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-2">🤝 친구 ID로 기록 조회</h3>
                    <div class="flex gap-2">
                        <input type="text" id="friend-user-id" placeholder="공유 받은 친구의 사용자 ID를 입력하세요 (비워두면 본인 조회)" 
                               class="p-2 border border-yellow-300 rounded-lg w-full shadow-sm text-sm focus:ring-yellow-500 focus:border-yellow-500">
                        <button id="self-search-button"
                                class="bg-gray-300 text-gray-700 py-2 px-4 rounded-xl hover:bg-gray-400 transition-colors duration-200 font-medium shadow-md flex-shrink-0 text-sm">
                            본인 조회
                        </button>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 items-center bg-gray-50 p-4 rounded-xl shadow-inner">
                    <div class="flex-1 w-full">
                        <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-1">시작일:</label>
                        <input type="date" id="report-start-date" class="p-2 border border-gray-300 rounded-lg w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex-1 w-full">
                        <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-1">종료일:</label>
                        <input type="date" id="report-end-date" class="p-2 border border-gray-300 rounded-lg w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button id="report-search-button" 
                            class="w-full sm:w-auto bg-blue-500 text-white py-2 px-6 rounded-xl hover:bg-blue-600 transition-colors duration-200 font-medium shadow-md self-end sm:mt-6">
                        기록 조회
                    </button>
                    </div>
                <div id="report-content" class="bg-white rounded-xl shadow-inner p-4 max-h-[60vh] overflow-y-auto">
                    <p class="text-gray-500 text-center p-10" id="report-loading-message">
                        저장된 기록을 불러오는 중...
                    </p>
                </div>
            </div>
            
        </div>
        
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="document.getElementById('modal-container').classList.add('hidden');">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-100" onclick="event.stopPropagation();">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">제목</h3>
            <p id="modal-message" class="text-gray-700 mb-4">메시지 내용</p>
            <button onclick="document.getElementById('modal-container').classList.add('hidden');"
                    class="w-full bg-indigo-600 text-white py-2 rounded-xl hover:bg-indigo-700 transition-colors duration-200 font-medium">
                확인
            </button>
        </div>
    </div>


    <script>
        // 전역 변수 설정
        let meals = [];
        const mealInput = {
            date: document.getElementById('meal-date'),
            name: document.getElementById('meal-name'),
            kcal: document.getElementById('meal-kcal'),
            carbs: document.getElementById('meal-carbs'),
            protein: document.getElementById('meal-protein'),
            fat: document.getElementById('meal-fat'),
            addButton: document.getElementById('add-meal-button'),
        };
        const saveButton = document.getElementById('save-button');
        const mealsList = document.getElementById('meals-list');
        const noMealsMessage = document.getElementById('no-meals-message');
        const totalsDisplay = {
            kcal: document.getElementById('total-kcal'),
            carbs: document.getElementById('total-carbs'),
            protein: document.getElementById('total-protein'),
            fat: document.getElementById('total-fat'),
        };
        const friendIdInput = document.getElementById('friend-user-id'); 

        // Firebase 인스턴스 (초기화 후 설정됨)
        let db, auth, userId, appId, initialAuthToken;

        // 에러 또는 성공 모달 표시 함수 (alert() 대체)
        function showModal(title, message, isError = false) {
            const container = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // 오류/성공 색상 변경
            if (isError) {
                modalTitle.classList.remove('text-green-600');
                modalTitle.classList.add('text-red-600');
            } else {
                modalTitle.classList.remove('text-red-600');
                modalTitle.classList.add('text-green-600');
            }

            container.classList.remove('hidden');
            // 애니메이션 효과를 위해 잠시 후 scale을 조정
            content.classList.remove('scale-90', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }

        // Firebase 초기화 함수
        async function initializeFirebase() {
            try {
                const instances = window.getFirebaseInstances();
                appId = instances.appId; 
                const firebaseConfig = instances.config; 
                const initialAuthToken = instances.initialAuthToken; 
                
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Firebase 설정이 올바르지 않습니다.");
                }
                
                const app = window.initializeApp(firebaseConfig);
                db = window.getFirestore(app);
                auth = window.getAuth(app);
                // window.setLogLevel('debug'); // 디버그 로그는 잠시 끕니다.

                await window.setPersistence(auth, window.browserSessionPersistence);

                // 4. 인증 처리 (커스텀 토큰 사용 또는 익명 로그인)
                try {
                    if (initialAuthToken) {
                        await window.signInWithCustomToken(auth, initialAuthToken); 
                    } else {
                        await window.signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.warn("인증 토큰 오류 발생, 익명 로그인 재시도:", authError);
                    // 토큰이 만료되었거나 잘못된 경우, 익명 로그인으로 폴백
                    await window.signInAnonymously(auth);
                }


                window.onAuthStateChanged(auth, (user) => {
                    const statusMessage = document.getElementById('auth-status-message');
                    const userIdDisplay = document.getElementById('user-id-display');

                    if (user) {
                        userId = user.uid;
                        window.setUserId(userId);
                        userIdDisplay.textContent = userId;
                        
                        statusMessage.classList.remove('bg-red-100', 'text-red-600', 'bg-yellow-100', 'text-yellow-600');
                        statusMessage.classList.add('bg-green-100', 'text-green-600');
                        statusMessage.textContent = `✅ 데이터베이스 연결 완료 (User ID: ${userId.substring(0, 8)}...)`;

                        // 인증 후 데이터 로드 시작
                        loadMealsForDate(mealInput.date.value);
                    } else {
                         // 익명 로그인 실패 시 사용자에게 알림
                        userId = null;
                        userIdDisplay.textContent = '인증 실패';
                        statusMessage.classList.remove('bg-green-100', 'text-green-600', 'bg-yellow-100', 'text-yellow-600');
                        statusMessage.classList.add('bg-red-100', 'text-red-600');
                        statusMessage.textContent = `❌ 데이터베이스 연결 실패: 인증 불가`;
                        showModal("연결 오류", "Firebase 인증을 완료하지 못했습니다. 새로고침 후 다시 시도해 주세요.", true);
                    }
                });

            } catch (error) {
                console.error("Firebase 초기화 또는 인증 오류:", error);
                document.getElementById('auth-status-message').textContent = `❌ 데이터베이스 연결 실패: ${error.message}`;
                document.getElementById('auth-status-message').classList.remove('bg-green-100', 'text-green-600', 'bg-yellow-100', 'text-yellow-600');
                document.getElementById('auth-status-message').classList.add('bg-red-100', 'text-red-600');
                db = null; 
            }
        }
        
        // ⭐️ Firestore 컬렉션 경로 생성 함수 (조회할 User ID를 인수로 받도록 수정) ⭐️
        function getCollectionPath(targetUserId) {
            const id = targetUserId || userId; 
            if (!id) {
                console.error("Target User ID is not defined.");
                return null;
            }
            // Private Data Path: /artifacts/{appId}/users/{userId}/daily_meals
            return `/artifacts/${appId}/users/${id}/daily_meals`;
        }


        // 현재 날짜의 식단 데이터 로드
        async function loadMealsForDate(date) {
            meals = []; 
            renderMeals(); 
            
            if (!db || !userId) {
                return;
            }

            try {
                // 저장 시에는 무조건 현재 사용자 ID를 사용
                const collectionPath = getCollectionPath(userId);
                if (!collectionPath) return;

                const docRef = window.doc(db, collectionPath, date);
                const docSnap = await window.getDoc(docRef);

                if (docSnap.exists()) {
                    meals = docSnap.data().meals || [];
                } else {
                    meals = [];
                }
            } catch (error) {
                console.error("데이터 로드 오류:", error);
                showModal("데이터 로드 오류", `식단을 불러오는 중 오류가 발생했습니다: ${error.message}. (Firestore 규칙을 확인해 보세요)`, true);
                meals = [];
            }
            renderMeals();
        }


        // 식단 목록 렌더링 및 합계 계산
        function renderMeals() {
            mealsList.innerHTML = '';
            
            let totalKcal = 0;
            let totalCarbs = 0;
            let totalProtein = 0;
            let totalFat = 0;

            if (meals.length === 0) {
                noMealsMessage.classList.remove('hidden');
                mealsList.appendChild(noMealsMessage);
            } else {
                noMealsMessage.classList.add('hidden');

                meals.forEach((meal, index) => {
                    const mealItem = document.createElement('div');
                    mealItem.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-white rounded-xl shadow-md border-l-4 border-indigo-400';
                    mealItem.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="font-bold text-gray-800">${meal.name}</p>
                            <p class="text-xs text-gray-500">
                                Kcal: ${meal.kcal} | 탄: ${meal.carbs}g | 단: ${meal.protein}g | 지: ${meal.fat}g
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="window.editMeal(${index})" 
                                    class="text-blue-500 hover:text-blue-700 transition-colors p-1 rounded-full text-sm font-medium">
                                수정
                            </button>
                            <button onclick="window.removeMeal(${index})" 
                                    class="text-red-500 hover:text-red-700 transition-colors p-1 rounded-full text-sm font-medium">
                                삭제
                            </button>
                        </div>
                    `;
                    mealsList.appendChild(mealItem);

                    totalKcal += meal.kcal;
                    totalCarbs += meal.carbs;
                    totalProtein += meal.protein;
                    totalFat += meal.fat;
                });
            }

            // 총 합계 업데이트
            totalsDisplay.kcal.textContent = totalKcal;
            totalsDisplay.carbs.textContent = totalCarbs;
            totalsDisplay.protein.textContent = totalProtein;
            totalsDisplay.fat.textContent = totalFat;
        }

        // 식단 수정 함수
        window.editMeal = function(index) {
            if (index < 0 || index >= meals.length) return;

            const mealToEdit = meals[index];

            // 1. 입력 필드에 데이터 로드
            mealInput.name.value = mealToEdit.name;
            mealInput.kcal.value = mealToEdit.kcal;
            mealInput.carbs.value = mealToEdit.carbs;
            mealInput.protein.value = mealToEdit.protein;
            mealInput.fat.value = mealToEdit.fat;
            mealInput.name.focus();

            // 2. 기존 항목을 목록에서 삭제 (수정 후 새로 추가할 예정)
            window.removeMeal(index);

            showModal("수정 모드", `${mealToEdit.name} 항목이 입력 필드에 로드되었습니다. 내용을 수정한 후 [+ 식단 추가] 버튼을 다시 누르세요.`, false);
        }

        // 식단 추가
        window.addMeal = function() {
            const name = mealInput.name.value.trim();
            const kcal = parseInt(mealInput.kcal.value) || 0;
            const carbs = parseInt(mealInput.carbs.value) || 0;
            const protein = parseInt(mealInput.protein.value) || 0;
            const fat = parseInt(mealInput.fat.value) || 0;

            if (!name || kcal <= 0) {
                showModal("입력 오류", "식단명과 0 이상의 칼로리(Kcal)는 필수 입력 사항입니다.", true);
                return;
            }

            const newMeal = {
                name,
                kcal,
                carbs,
                protein,
                fat,
                timestamp: new Date().toISOString() // 입력 시간 기록
            };

            meals.push(newMeal);
            renderMeals();

            // 입력 필드 초기화 (날짜는 그대로 둠)
            mealInput.name.value = '';
            mealInput.kcal.value = '';
            mealInput.carbs.value = '';
            mealInput.protein.value = '';
            mealInput.fat.value = '';
            mealInput.name.focus();
        }

        // 식단 삭제
        window.removeMeal = function(index) {
            meals.splice(index, 1);
            renderMeals();
        }

        // 식단 저장 (setDoc을 사용하여 날짜별로 덮어쓰기)
        async function saveTodaysMeals() {
            if (!db || !userId) {
                showModal("저장 오류", "데이터베이스 연결이 준비되지 않았습니다. 잠시 후 다시 시도해 주세요.", true);
                return;
            }

            const date = mealInput.date.value;
            if (!date) {
                showModal("저장 오류", "저장할 날짜를 선택해주세요.", true);
                return;
            }
            
            // 저장 시에는 무조건 현재 사용자 ID를 사용
            const collectionPath = getCollectionPath(userId);
            if (!collectionPath) return;

            // 저장할 데이터 객체
            const dataToSave = {
                meals: meals,
                totalKcal: parseInt(totalsDisplay.kcal.textContent),
                totalCarbs: parseInt(totalsDisplay.carbs.textContent),
                totalProtein: parseInt(totalsDisplay.protein.textContent),
                totalFat: parseInt(totalsDisplay.fat.textContent),
                lastUpdated: new Date().toISOString()
            };

            try {
                // setDoc을 사용하여 해당 날짜 문서에 데이터 저장 (덮어쓰기)
                const docRef = window.doc(db, collectionPath, date);
                await window.setDoc(docRef, dataToSave);

                showModal("저장 완료", `${date}의 식단 ${meals.length}개가 성공적으로 저장되었습니다.`, false);
                
            } catch (error) {
                console.error("데이터 저장 오류:", error);
                showModal("데이터 저장 오류", `식단을 저장하는 중 오류가 발생했습니다: ${error.message}. (Firestore 규칙의 write 권한을 확인해 보세요)`, true);
            }
        }


        // 뷰 전환 기능
        window.switchView = function(viewName) {
            const dailyInputView = document.getElementById('daily-input-view');
            const reportView = document.getElementById('report-view');
            const tabDaily = document.getElementById('tab-daily-input');
            const tabReport = document.getElementById('tab-report');

            if (viewName === 'daily-input') {
                dailyInputView.classList.remove('hidden');
                reportView.classList.add('hidden');
                
                tabDaily.classList.add('border-indigo-500', 'text-indigo-600');
                tabDaily.classList.remove('border-transparent', 'text-gray-500');
                tabReport.classList.remove('border-indigo-500', 'text-indigo-600');
                tabReport.classList.add('border-transparent', 'text-gray-500');

                // 일일 입력 뷰로 돌아오면 현재 날짜 데이터 다시 로드
                loadMealsForDate(mealInput.date.value);

            } else if (viewName === 'report') {
                dailyInputView.classList.add('hidden');
                reportView.classList.remove('hidden');

                tabReport.classList.add('border-indigo-500', 'text-indigo-600');
                tabReport.classList.remove('border-transparent', 'text-gray-500');
                tabDaily.classList.remove('border-indigo-500', 'text-indigo-600');
                tabDaily.classList.add('border-transparent', 'text-gray-500');

                // 보고서 뷰로 이동하면 기록 로드 시작
                renderReport();
            }
        }

        // ⭐️ 보고서 기록 조회 (친구 ID로 조회 가능하도록 수정된 핵심 함수) ⭐️
        window.renderReport = async function() {
            const reportContent = document.getElementById('report-content');
            const loadingMessage = document.getElementById('report-loading-message');
            
            reportContent.innerHTML = ''; 
            loadingMessage.textContent = "저장된 기록을 불러오는 중...";
            reportContent.appendChild(loadingMessage);
            loadingMessage.classList.remove('hidden');
            loadingMessage.classList.remove('text-red-500'); 
            loadingMessage.classList.add('text-gray-500');

            // 1. 조회할 사용자 ID 결정 (친구 ID 입력 필드를 먼저 확인)
            const targetFriendId = friendIdInput.value.trim();
            const targetUserId = targetFriendId || userId; // 친구 ID가 있으면 친구 ID 사용, 없으면 본인 ID 사용
            const isFriendView = !!targetFriendId; 
            
            const displayUserId = targetUserId ? targetUserId.substring(0, 8) + '...' : 'ID 없음';
            const viewTitle = isFriendView ? `친구 (${displayUserId})의 기록` : `본인 (${userId ? userId.substring(0, 8) + '...' : 'ID 없음'})의 기록`;

            // 2. 기간별 조회 날짜 읽기
            const startDate = document.getElementById('report-start-date')?.value;
            const endDate = document.getElementById('report-end-date')?.value;

            if (!startDate || !endDate) {
                loadingMessage.textContent = `${viewTitle}: 조회할 시작일과 종료일을 선택해주세요.`;
                loadingMessage.classList.add('text-red-500');
                return;
            }
            if (startDate > endDate) {
                loadingMessage.textContent = `${viewTitle}: 시작일은 종료일보다 이전 날짜여야 합니다.`;
                loadingMessage.classList.add('text-red-500');
                return;
            }
            
            if (!db || !targetUserId) {
                loadingMessage.textContent = `❌ ${viewTitle}: 데이터베이스 연결 실패 또는 사용자 ID를 찾을 수 없습니다.`;
                loadingMessage.classList.remove('text-gray-500');
                loadingMessage.classList.add('text-red-500');
                return;
            }

            try {
                // 3. 컬렉션 경로 생성 (targetUserId를 getCollectionPath에 전달)
                const collectionPath = getCollectionPath(targetUserId);
                if (!collectionPath) return;

                // 4. 쿼리 실행
                const q = window.query(
                    window.collection(db, collectionPath),
                    window.where(window.documentId(), '>=', startDate),
                    window.where(window.documentId(), '<=', endDate)
                );
                
                const querySnapshot = await window.getDocs(q);

                const reportData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    reportData.push({ 
                        date: doc.id,
                        ...data
                    });
                });

                reportData.sort((a, b) => b.date.localeCompare(a.date));

                loadingMessage.classList.add('hidden');

                if (reportData.length === 0) {
                    reportContent.innerHTML = `<p class="text-gray-500 text-center p-10">${viewTitle}: 해당 기간에 저장된 식단 기록이 없습니다.</p>`;
                    return;
                }
                
                // 5. 결과 렌더링
                reportContent.innerHTML = `<h3 class="text-xl font-bold text-gray-700 mb-4">${viewTitle}</h3>`;

                reportData.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'bg-gray-50 p-4 rounded-lg shadow-sm mb-4 border-t-4 border-blue-400';

                    const totalMeals = day.meals ? day.meals.length : 0;
                    const totalKcal = day.totalKcal || 0;
                    const totalCarbs = day.totalCarbs || 0;
                    const totalProtein = day.totalProtein || 0;
                    const totalFat = day.totalFat || 0;

                    let mealListHtml = '';
                    if (day.meals && day.meals.length > 0) {
                        mealListHtml = day.meals.map(meal => `
                            <li class="text-sm text-gray-700 ml-4 list-disc">
                                ${meal.name}: ${meal.kcal} Kcal (탄:${meal.carbs}g, 단:${meal.protein}g, 지:${meal.fat}g)
                            </li>
                        `).join('');
                    } else {
                        mealListHtml = '<li class="text-sm text-gray-500 ml-4">이날은 상세 기록이 없습니다.</li>';
                    }

                    dayElement.innerHTML = `
                        <h3 class="text-xl font-bold text-blue-700 mb-2">${day.date}</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-sm font-medium text-gray-600 mb-3 border-b pb-2">
                            <p>총 식단: <span class="text-blue-500 font-semibold">${totalMeals}건</span></p>
                            <p>총 Kcal: <span class="text-blue-500 font-semibold">${totalKcal}</span></p>
                            <p>총 탄수화물(g): <span class="text-blue-500 font-semibold">${totalCarbs}</span></p>
                            <p>총 단백질(g): <span class="text-blue-500 font-semibold">${totalProtein}</span></p>
                            <p>총 지방(g): <span class="text-blue-500 font-semibold">${totalFat}</span></p>
                        </div>
                        <h4 class="font-semibold text-gray-700 mb-1">상세 식단 항목:</h4>
                        <ul class="space-y-1">${mealListHtml}</ul>
                    `;
                    reportContent.appendChild(dayElement);
                });

            } catch (error) {
                console.error("보고서 조회 오류:", error);
                reportContent.innerHTML = `<p class="text-red-500 text-center p-10">
                    ❌ 기록을 불러오는 중 오류가 발생했습니다: ${error.message}
                    <br><br>
                    (친구가 본인의 ID를 정확히 입력했고, Firestore 규칙이 **읽기 권한을 허용**하는지 확인하세요.)
                </p>`;
            }
        }


        // 이벤트 리스너
        window.onload = function() {
            // 날짜 입력 필드의 기본값을 오늘 날짜로 설정
            const today = new Date().toISOString().substring(0, 10);
            mealInput.date.value = today;

            // 보고서 날짜 기본값 설정 (이번 달 1일 ~ 오늘)
            const reportStartDate = document.getElementById('report-start-date');
            const reportEndDate = document.getElementById('report-end-date');
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().substring(0, 10);
            
            if(reportStartDate) reportStartDate.value = firstDayOfMonth;
            if(reportEndDate) reportEndDate.value = today;
            
            // 1. 날짜 변경 시 해당 날짜 데이터 로드
            mealInput.date.addEventListener('change', (e) => loadMealsForDate(e.target.value));

            // 2. 버튼 클릭 이벤트 리스너 연결
            mealInput.addButton.addEventListener('click', window.addMeal);
            saveButton.addEventListener('click', saveTodaysMeals);
            
            // ⭐️ 보고서 조회 버튼에 직접 이벤트 리스너 연결 ⭐️
            document.getElementById('report-search-button').addEventListener('click', window.renderReport);
            document.getElementById('self-search-button').addEventListener('click', () => {
                friendIdInput.value = '';
                window.renderReport();
            });
            // ⭐️ ----------------------------------- ⭐️
            
            // 3. Firebase 초기화 및 인증 시작
            initializeFirebase();
        };

    </script>
</body>
</html>