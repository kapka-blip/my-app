<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일일 식단 자동 계산기</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 기본 폰트 설정 */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        /* 숫자 입력 필드에서 화살표 버튼 숨기기 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-4xl">
        
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">
            일일 식단 자동 계산기
        </h1>
        <!-- ⚠️ Firebase 설정이 없으면 이 메시지가 유지됩니다. -->
        <p id="user-info" class="text-xs text-center text-gray-500 mb-6">[사용자 인증 중...]</p>
        
        <!-- 1. 총 합계 표시 영역 -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-blue-600 mb-1">총 칼로리 (Kcal)</div>
                <div id="total-kcal" class="text-2xl font-bold text-blue-800">0</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-green-600 mb-1">총 탄수화물 (g)</div>
                <div id="total-carbs" class="text-2xl font-bold text-green-800">0</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-red-600 mb-1">총 단백질 (g)</div>
                <div id="total-protein" class="text-2xl font-bold text-red-800">0</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-yellow-600 mb-1">총 지방 (g)</div>
                <div id="total-fat" class="text-2xl font-bold text-yellow-800">0</div>
            </div>
        </div>

        <!-- 2. 식단 입력 폼 -->
        <form id="meal-form" class="space-y-4 sm:space-y-0 sm:flex sm:items-end sm:space-x-4">
            <!-- 날짜 입력 -->
            <div class="flex-grow min-w-0" style="flex-basis: 140px;">
                <label for="meal-date" class="block text-sm font-medium text-gray-700">날짜</label>
                <input type="date" id="meal-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- 식단명 입력 -->
            <div class="flex-grow min-w-0" style="flex-basis: 200px;">
                <label for="meal-name" class="block text-sm font-medium text-gray-700">식단명</label>
                <input type="text" id="meal-name" placeholder="예: 닭가슴살 샐러드" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- 칼로리 입력 -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="kcal" class="block text-sm font-medium text-gray-700">Kcal</label>
                <input type="number" id="kcal" placeholder="숫자만 입력" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- 탄수화물 입력 -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="carbs" class="block text-sm font-medium text-gray-700">탄수화물(g)</label>
                <input type="number" id="carbs" placeholder="숫자만 입력" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- 단백질 입력 -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="protein" class="block text-sm font-medium text-gray-700">단백질(g)</label>
                <input type="number" id="protein" placeholder="숫자만 입력" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- 지방 입력 -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="fat" class="block text-sm font-medium text-gray-700">지방(g)</label>
                <input type="number" id="fat" placeholder="숫자만 입력" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- 추가/저장 버튼 -->
            <button type="submit" id="submit-button" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                추가
            </button>
        </form>

        <!-- 최종 저장 버튼 -->
        <!-- Firebase 설정 오류 시 이 버튼은 클라우드 저장을 시도하므로 계속 오류가 발생할 수 있습니다. -->
        <button type="button" onclick="saveDailyRecord()" class="mt-4 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            오늘의 식단 최종 저장 (클라우드)
        </button>


        <!-- 3. 추가된 식단 목록 -->
        <h2 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">오늘의 식단 (미저장, 로컬에 임시 보관 중)</h2>
        <div class="overflow-x-auto mb-10">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">식단명</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">탄수화물 (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">단백질 (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">지방 (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
                    </tr>
                </thead>
                <tbody id="meal-list" class="bg-white divide-y divide-gray-200">
                    <tr id="initial-example" class="opacity-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic">예: 10월 31일</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic">예: 슬림쿡 목살 스테이크</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">355</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">29</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">17</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">21</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 4. 날짜별 저장 기록 -->
        <h2 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">날짜별 저장 기록 (총합계)</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">탄수화물 (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">단백질 (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">지방 (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">상세</th>
                    </tr>
                </thead>
                <tbody id="daily-records-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">저장된 일일 기록을 불러오는 중... (클라우드)</td>
                    </tr>
                </tbody>
            </table>
        </div>


    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { QueryConstraint, limit, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // orderBy 추가

        // --- 0. 전역 설정 및 변수 선언 ---

        // 🚨 중요: 여기에 사용자님의 실제 Firebase Config 값을 붙여넣어 주세요! 
        const manualFirebaseConfig = {
              apiKey: "AIzaSyCjyTrnhFuGV8PVD3mtMj9ZD7DFX4J3s",
              authDomain: "meal-tracker-f2644.firebaseapp.com",
              projectId: "meal-tracker-f2644",
              storageBucket: "meal-tracker-f2644.appspot.com",
              messagingSenderId: "739384992411",
              appId: "1:739384992411:web:1e47f734197cd6dff89c3e"
            };

        // Firebase 전역 변수 (GitHub Pages 환경을 위한 수동 설정)
        const __app_id = 'diet_calculator'; 
        const __firebase_config = JSON.stringify(manualFirebaseConfig);
        const __initial_auth_token = ''; // GitHub Pages에서는 사용하지 않으므로 빈 문자열로 둡니다.

        let db = null;
        let auth = null;
        let isCloudEnabled = false;
        let userId = 'local-anonymous-user-' + crypto.randomUUID(); // 클라우드 비활성화 시 사용될 임시 ID

        // UI 요소
        const mealInput = {
            date: document.getElementById('meal-date'),
            name: document.getElementById('meal-name'),
            kcal: document.getElementById('meal-kcal'),
            carbs: document.getElementById('meal-carbs'),
            protein: document.getElementById('meal-protein'),
            fat: document.getElementById('meal-fat'),
            addButton: document.getElementById('add-meal')
        };
        const summary = {
            kcal: document.getElementById('summary-kcal'),
            carbs: document.getElementById('summary-carbs'),
            protein: document.getElementById('summary-protein'),
            fat: document.getElementById('summary-fat')
        };
        const statusMessage = document.getElementById('status-message');
        const mealList = document.getElementById('meal-list');
        const totalRecordList = document.getElementById('total-record-list');
        const saveButton = document.getElementById('save-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // 상태
        let meals = loadLocalMeals(); // 미저장 식단
        let totalRecords = {}; // 날짜별 저장 기록

        // --- 1. Firebase 초기화 및 인증 ---

        function updateStatus(message, isError = false) {
            statusMessage.innerHTML = message;
            statusMessage.className = isError ? 'text-red-600' : 'text-gray-600';
            console.log(`STATUS: ${message}`);
        }

        // Firebase를 초기화하는 핵심 로직 (수정됨)
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                
                // Config가 유효하지 않으면 클라우드 비활성화
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.length < 10) {
                    throw new Error("Missing or invalid Firebase configuration.");
                }

                // Config가 유효할 경우에만 초기화 진행
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Firestore 로그 레벨 설정 (디버깅용)
                setLogLevel('error'); // 배포 시에는 'error'로 설정하여 불필요한 로그를 줄입니다.

                // 익명 인증 및 사용자 상태 감지
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            // 익명 로그인 시도
                            try {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                updateStatus(`ID: ${userId} (클라우드 연결됨)`, false);
                                isCloudEnabled = true;
                            } catch (error) {
                                console.error("Firebase 익명 로그인 실패:", error);
                                updateStatus('Firebase 인증 실패. 클라우드 저장 비활성화.', true);
                                isCloudEnabled = false;
                            }
                        } else {
                            userId = user.uid;
                            updateStatus(`ID: ${userId} (클라우드 연결됨)`, false);
                            isCloudEnabled = true;
                        }
                        unsubscribe(); // 초기 인증 확인 후 리스너 해제
                        resolve();
                    });
                });

                if (isCloudEnabled) {
                    setupCloudListeners();
                }
            } catch (e) {
                console.error("Firebase 초기화 중 치명적인 오류 발생:", e);
                updateStatus(`Firebase 설정 오류. (ID: ${userId} / 클라우드 저장 비활성화)`, true);
                showErrorModal("Firebase 연결 오류", "Firebase 설정 또는 네트워크 문제로 클라우드 데이터 저장이 불가능합니다. 로그인이 필수적인 기능이므로, 로컬 임시 저장소는 작동합니다.");
                isCloudEnabled = false;
            }
        }

        // --- 2. 로컬 저장소 (Local Storage) 기능 ---
        
        // ... (loadLocalMeals, saveLocalMeals, etc.는 동일)
        function loadLocalMeals() {
            const data = localStorage.getItem('localMeals');
            return data ? JSON.parse(data) : [];
        }

        function saveLocalMeals() {
            localStorage.setItem('localMeals', JSON.stringify(meals));
        }


        // --- 3. 클라우드 저장소 (Firestore) 기능 ---
        
        // Firestore 데이터베이스 경로 설정
        function getCollectionPath() {
            // Firestore 규칙에 따라 사용자별로 데이터를 저장합니다.
            return `artifacts/${__app_id}/users/${userId}/meal_records`;
        }

        // Firestore 리스너 설정
        function setupCloudListeners() {
            if (!isCloudEnabled || !db) return;

            // 1. 날짜별 총합계 기록 리스너
            const totalQuery = query(collection(db, getCollectionPath()));

            onSnapshot(totalQuery, (snapshot) => {
                loadingIndicator.textContent = "저장된 일일 기록을 불러오는 중... (클라우드)";
                totalRecords = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = doc.id; // 문서 ID를 날짜로 사용
                    totalRecords[date] = {
                        kcal: data.totalKcal,
                        carbs: data.totalCarbs,
                        protein: data.totalProtein,
                        fat: data.totalFat
                    };
                });
                renderTotalRecords();
                loadingIndicator.textContent = "";
            }, (error) => {
                console.error("클라우드 기록 리스너 오류:", error);
                loadingIndicator.textContent = "클라우드 기록을 불러오는 중 오류 발생.";
            });
        }


        // 최종 저장 함수 (로컬 -> 클라우드)
        async function saveTodaysMeals() {
            if (!isCloudEnabled || !db) {
                showErrorModal("저장 불가", "클라우드 저장 기능이 활성화되지 않았습니다. Firebase 설정을 완료하고 페이지를 새로고침하세요.");
                return;
            }
            
            if (meals.length === 0) {
                showErrorModal("경고", "저장할 식단 기록이 없습니다.");
                return;
            }

            try {
                // 당일 날짜 계산
                const today = new Date().toISOString().substring(0, 10);
                
                // 총합계 계산
                const totals = meals.reduce((acc, meal) => {
                    acc.totalKcal += meal.kcal;
                    acc.totalCarbs += meal.carbs;
                    acc.totalProtein += meal.protein;
                    acc.totalFat += meal.fat;
                    return acc;
                }, { totalKcal: 0, totalCarbs: 0, totalProtein: 0, totalFat: 0 });

                // Firestore에 문서 ID를 날짜로 사용하여 저장
                const mealDocRef = doc(db, getCollectionPath(), today);

                await setDoc(mealDocRef, {
                    meals: meals, // 모든 상세 식단 기록
                    totalKcal: totals.totalKcal,
                    totalCarbs: totals.totalCarbs,
                    totalProtein: totals.totalProtein,
                    totalFat: totals.totalFat,
                    timestamp: serverTimestamp()
                });

                // 저장 성공 시 미저장 식단 목록 초기화
                meals = [];
                saveLocalMeals();
                renderMeals();
                showErrorModal("성공", `${today} 식단 기록이 클라우드에 성공적으로 저장되었습니다.`);

            } catch (e) {
                console.error("클라우드 저장 중 오류 발생:", e);
                showErrorModal("저장 실패", "클라우드에 데이터를 저장하는 중 오류가 발생했습니다. 네트워크 또는 Firebase 설정을 확인하세요.");
            }
        }
        
        // 상세 기록 로드 함수
        async function loadMealDetails(date) {
            if (!isCloudEnabled || !db) {
                showErrorModal("조회 불가", "클라우드 연결이 활성화되지 않아 상세 기록을 볼 수 없습니다.");
                return [];
            }
            try {
                const docRef = doc(db, getCollectionPath(), date);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    return docSnap.data().meals || [];
                } else {
                    showErrorModal("오류", `${date}의 상세 기록을 찾을 수 없습니다.`);
                    return [];
                }
            } catch (e) {
                console.error("상세 기록 로드 오류:", e);
                showErrorModal("오류", "상세 기록을 불러오는 중 오류가 발생했습니다.");
                return [];
            }
        }


        // --- 4. 렌더링 및 UI 기능 ---

        // ... (addMeal, deleteMeal, renderMeals, renderTotalRecords, etc.는 동일)
        function calculateSummary() {
            const totals = meals.reduce((acc, meal) => {
                acc.kcal += meal.kcal;
                acc.carbs += meal.carbs;
                acc.protein += meal.protein;
                acc.fat += meal.fat;
                return acc;
            }, { kcal: 0, carbs: 0, protein: 0, fat: 0 });

            summary.kcal.textContent = totals.kcal;
            summary.carbs.textContent = totals.carbs;
            summary.protein.textContent = totals.protein;
            summary.fat.textContent = totals.fat;
        }
        
        // 미저장 식단 렌더링
        function renderMeals() {
            calculateSummary();
            mealList.innerHTML = '';

            if (meals.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="py-4 text-center text-gray-500">오늘의 식단을 추가해 주세요.</td>`;
                mealList.appendChild(row);
                return;
            }

            meals.forEach((meal, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b text-sm';
                row.innerHTML = `
                    <td class="px-2 py-2">${meal.date}</td>
                    <td class="px-2 py-2">${meal.name}</td>
                    <td class="px-2 py-2">${meal.kcal}</td>
                    <td class="px-2 py-2">${meal.carbs} (G)</td>
                    <td class="px-2 py-2">${meal.protein} (G)</td>
                    <td class="px-2 py-2">${meal.fat} (G)</td>
                    <td class="px-2 py-2 space-x-2 whitespace-nowrap">
                        <button onclick="editMeal(${index})" class="text-blue-500 hover:text-blue-700 text-xs">수정</button>
                        <button onclick="deleteMeal(${index})" class="text-red-500 hover:text-red-700 text-xs">삭제</button>
                    </td>
                `;
                mealList.appendChild(row);
            });
            saveLocalMeals();
        }

        // 저장된 기록 렌더링
        function renderTotalRecords() {
            totalRecordList.innerHTML = '';
            const dates = Object.keys(totalRecords).sort().reverse();
            
            if (dates.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" class="py-4 text-center text-gray-500">클라우드에 저장된 기록이 없습니다.</td>`;
                totalRecordList.appendChild(row);
                return;
            }

            dates.forEach((date) => {
                const record = totalRecords[date];
                const row = document.createElement('tr');
                row.className = 'border-b text-sm';
                row.innerHTML = `
                    <td class="px-2 py-2">${date}</td>
                    <td class="px-2 py-2">${record.kcal}</td>
                    <td class="px-2 py-2">${record.carbs} (G)</td>
                    <td class="px-2 py-2">${record.protein} (G)</td>
                    <td class="px-2 py-2">${record.fat} (G)</td>
                    <td class="px-2 py-2 whitespace-nowrap">
                        <button onclick="showDetails('${date}')" class="text-teal-500 hover:text-teal-700 text-xs">상세</button>
                    </td>
                `;
                totalRecordList.appendChild(row);
            });
        }
        
        // 상세 기록 모달 표시
        async function showDetails(date) {
            const modalBody = document.getElementById('details-modal-body');
            const modalTitle = document.getElementById('details-modal-title');
            
            modalTitle.textContent = `${date} 식단 상세 기록`;
            modalBody.innerHTML = `<p class="text-center text-gray-500">상세 기록을 불러오는 중...</p>`;
            document.getElementById('details-modal').classList.remove('hidden');

            const details = await loadMealDetails(date);

            if (details.length === 0) {
                 modalBody.innerHTML = `<p class="text-center text-red-500">기록을 불러올 수 없거나 상세 기록이 없습니다.</p>`;
                 return;
            }

            let html = `<table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">식단명</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">탄수화물(G)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">단백질(G)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">지방(G)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;

            details.forEach(meal => {
                html += `<tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.name}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.kcal}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.carbs}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.protein}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.fat}</td>
                         </tr>`;
            });
            
            html += `</tbody></table>`;
            modalBody.innerHTML = html;
        }

        // 모달 닫기
        window.closeModal = function() {
            document.getElementById('details-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.add('hidden');
            // 수정 모달 닫기
            document.getElementById('edit-modal').classList.add('hidden');
        }
        
        // 오류 모달 표시
        function showErrorModal(title, message) {
            document.getElementById('error-modal-title').textContent = title;
            document.getElementById('error-modal-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        // 식단 추가 핸들러
        window.addMeal = function() {
            const meal = {
                date: mealInput.date.value,
                name: mealInput.name.value.trim(),
                kcal: parseInt(mealInput.kcal.value) || 0,
                carbs: parseInt(mealInput.carbs.value) || 0,
                protein: parseInt(mealInput.protein.value) || 0,
                fat: parseInt(mealInput.fat.value) || 0,
            };

            if (!meal.name || meal.kcal <= 0) {
                showErrorModal("입력 오류", "식단명과 0 이상의 칼로리(Kcal)는 필수 입력 사항입니다.");
                return;
            }

            meals.push(meal);
            renderMeals();
            
            // 입력 필드 초기화
            mealInput.name.value = '';
            mealInput.kcal.value = '';
            mealInput.carbs.value = '';
            mealInput.protein.value = '';
            mealInput.fat.value = '';
            mealInput.name.focus();
        };
        
        // 식단 삭제 핸들러
        window.deleteMeal = function(index) {
            meals.splice(index, 1);
            renderMeals();
        };

        // 식단 수정 모달 열기
        window.editMeal = function(index) {
            const meal = meals[index];
            document.getElementById('edit-meal-name').value = meal.name;
            document.getElementById('edit-meal-kcal').value = meal.kcal;
            document.getElementById('edit-meal-carbs').value = meal.carbs;
            document.getElementById('edit-meal-protein').value = meal.protein;
            document.getElementById('edit-meal-fat').value = meal.fat;
            document.getElementById('edit-modal-save').onclick = () => saveEdit(index);
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        
        // 식단 수정 저장
        window.saveEdit = function(index) {
            const name = document.getElementById('edit-meal-name').value.trim();
            const kcal = parseInt(document.getElementById('edit-meal-kcal').value) || 0;
            const carbs = parseInt(document.getElementById('edit-meal-carbs').value) || 0;
            const protein = parseInt(document.getElementById('edit-meal-protein').value) || 0;
            const fat = parseInt(document.getElementById('edit-meal-fat').value) || 0;

            if (!name || kcal <= 0) {
                showErrorModal("입력 오류", "식단명과 0 이상의 칼로리(Kcal)는 필수 입력 사항입니다.");
                return;
            }

            meals[index] = { ...meals[index], name, kcal, carbs, protein, fat };
            renderMeals();
            document.getElementById('edit-modal').classList.add('hidden');
        }


        // 이벤트 리스너
        window.onload = function() {
            // 날짜 입력 필드의 기본값을 오늘 날짜로 설정
            const today = new Date().toISOString().substring(0, 10);
            mealInput.date.value = today;

            mealInput.addButton.addEventListener('click', window.addMeal);
            saveButton.addEventListener('click', saveTodaysMeals);
            
            // 초기 렌더링 및 Firebase 초기화
            renderMeals();
            initializeFirebase();
        };

        // 전역으로 필요한 함수 노출
        window.showDetails = showDetails;
        window.loadMealDetails = loadMealDetails;

    </script>


</body>
</html>
