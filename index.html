<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì¼ ì‹ë‹¨ ìë™ ê³„ì‚°ê¸°</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        /* ìˆ«ì ì…ë ¥ í•„ë“œì—ì„œ í™”ì‚´í‘œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-4xl">
        
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">
            ì¼ì¼ ì‹ë‹¨ ìë™ ê³„ì‚°ê¸°
        </h1>
        <p id="user-info" class="text-xs text-center text-gray-500 mb-6">[ì‚¬ìš©ì ì¸ì¦ ì¤‘...]</p>
        
        <!-- 1. ì´ í•©ê³„ í‘œì‹œ ì˜ì—­ -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-blue-600 mb-1">ì´ ì¹¼ë¡œë¦¬ (Kcal)</div>
                <div id="total-kcal" class="text-2xl font-bold text-blue-800">0</div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-green-600 mb-1">ì´ íƒ„ìˆ˜í™”ë¬¼ (g)</div>
                <div id="total-carbs" class="text-2xl font-bold text-green-800">0</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-red-600 mb-1">ì´ ë‹¨ë°±ì§ˆ (g)</div>
                <div id="total-protein" class="text-2xl font-bold text-red-800">0</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center shadow-sm">
                <div class="text-sm font-semibold text-yellow-600 mb-1">ì´ ì§€ë°© (g)</div>
                <div id="total-fat" class="text-2xl font-bold text-yellow-800">0</div>
            </div>
        </div>

        <!-- 2. ì‹ë‹¨ ì…ë ¥ í¼ -->
        <form id="meal-form" class="space-y-4 sm:space-y-0 sm:flex sm:items-end sm:space-x-4">
            <!-- ë‚ ì§œ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 140px;">
                <label for="meal-date" class="block text-sm font-medium text-gray-700">ë‚ ì§œ</label>
                <input type="date" id="meal-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- ì‹ë‹¨ëª… ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 200px;">
                <label for="meal-name" class="block text-sm font-medium text-gray-700">ì‹ë‹¨ëª…</label>
                <input type="text" id="meal-name" placeholder="ì˜ˆ: ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- ì¹¼ë¡œë¦¬ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="kcal" class="block text-sm font-medium text-gray-700">Kcal</label>
                <input type="number" id="kcal" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- íƒ„ìˆ˜í™”ë¬¼ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="carbs" class="block text-sm font-medium text-gray-700">íƒ„ìˆ˜í™”ë¬¼(g)</label>
                <input type="number" id="carbs" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- ë‹¨ë°±ì§ˆ ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="protein" class="block text-sm font-medium text-gray-700">ë‹¨ë°±ì§ˆ(g)</label>
                <input type="number" id="protein" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- ì§€ë°© ì…ë ¥ -->
            <div class="flex-grow min-w-0" style="flex-basis: 110px;">
                <label for="fat" class="block text-sm font-medium text-gray-700">ì§€ë°©(g)</label>
                <input type="number" id="fat" placeholder="ìˆ«ìë§Œ ì…ë ¥" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- ì¶”ê°€/ì €ì¥ ë²„íŠ¼ -->
            <button type="submit" id="submit-button" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ì¶”ê°€
            </button>
        </form>

        <!-- ìµœì¢… ì €ì¥ ë²„íŠ¼ -->
        <button type="button" onclick="saveDailyRecord()" class="mt-4 w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ìµœì¢… ì €ì¥
        </button>


        <!-- 3. ì¶”ê°€ëœ ì‹ë‹¨ ëª©ë¡ -->
        <h2 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">ì˜¤ëŠ˜ì˜ ì‹ë‹¨ (ë¯¸ì €ì¥)</h2>
        <div class="overflow-x-auto mb-10">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚ ì§œ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‹ë‹¨ëª…</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">íƒ„ìˆ˜í™”ë¬¼ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ë‹¨ë°±ì§ˆ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ë°© (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="meal-list" class="bg-white divide-y divide-gray-200">
                    <tr id="initial-example" class="opacity-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic">ì˜ˆ: 10ì›” 31ì¼</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 italic">ì˜ˆ: ìŠ¬ë¦¼ì¿¡ ëª©ì‚´ ìŠ¤í…Œì´í¬</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">355</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">29</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">17</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right italic">21</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 4. ë‚ ì§œë³„ ì €ì¥ ê¸°ë¡ -->
        <h2 class="text-xl font-bold text-gray-800 mt-8 mb-4 border-b pb-2">ë‚ ì§œë³„ ì €ì¥ ê¸°ë¡ (ì´í•©ê³„)</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚ ì§œ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Kcal</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">íƒ„ìˆ˜í™”ë¬¼ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ë‹¨ë°±ì§ˆ (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ì§€ë°© (g)</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒì„¸</th>
                    </tr>
                </thead>
                <tbody id="daily-records-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">ì €ì¥ëœ ì¼ì¼ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>


    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 0. ì „ì—­ ì„¤ì • ë° ë³€ìˆ˜ ì„ ì–¸ ---
        
        // ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ Firebase Config ê°’ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”! 
        // Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ firebaseConfig ê°ì²´ë¥¼ ì´ ë¶€ë¶„ì— ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
        // ì˜ˆì‹œ: const manualFirebaseConfig = { apiKey: "...", authDomain: "...", ... };
        const manualFirebaseConfig = null; // ì—¬ê¸°ì— ì‚¬ìš©ì Firebase Config ê°’ ë¶™ì—¬ë„£ê¸°

        // Firebase ì „ì—­ ë³€ìˆ˜ (GitHub Pages í™˜ê²½ì„ ìœ„í•œ ìˆ˜ë™ ì„¤ì •)
        const appId = manualFirebaseConfig ? manualFirebaseConfig.projectId : 'default-app-id';
        const firebaseConfig = manualFirebaseConfig;
        
        // ìº”ë²„ìŠ¤ í™˜ê²½ì´ ì•„ë‹ˆë¯€ë¡œ ì´ˆê¸° í† í°ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        const initialAuthToken = null; 

        // Firebase State
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let dailyRecords = []; // ì €ì¥ëœ ì¼ì¼ ê¸°ë¡ ë°ì´í„°

        // HTML ìš”ì†Œ ì„ íƒ (ì´í•˜ ìƒëµ - ì´ì „ ì½”ë“œì™€ ë™ì¼)
        const mealForm = document.getElementById('meal-form');
        const mealDateInput = document.getElementById('meal-date');
        const mealNameInput = document.getElementById('meal-name');
        const kcalInput = document.getElementById('kcal');
        const carbsInput = document.getElementById('carbs');
        const proteinInput = document.getElementById('protein');
        const fatInput = document.getElementById('fat');
        const totalKcalEl = document.getElementById('total-kcal');
        const totalCarbsEl = document.getElementById('total-carbs');
        const totalProteinEl = document.getElementById('total-protein');
        const totalFatEl = document.getElementById('total-fat');
        const mealList = document.getElementById('meal-list');
        const initialExampleRow = document.getElementById('initial-example');
        const submitButton = document.getElementById('submit-button');

        // ì•± ìƒíƒœ (ë¯¸ì €ì¥ ì‹ë‹¨)
        let meals = []; 
        let editingMealId = null; 

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • ë° ì˜ˆì‹œ í–‰ ìˆ¨ê¸°ê¸°
        mealDateInput.valueAsDate = new Date();
        if (initialExampleRow) {
            initialExampleRow.style.display = 'none';
        }

        // --- 1. ìœ í‹¸ë¦¬í‹° ë° UI í•¨ìˆ˜ ---
        
        /** Custom Alert/Modal Function (ê²½ê³  ë©”ì‹œì§€ìš©) */
        function showCustomAlert(title, message, color, isHtml = false) {
            const existingModal = document.querySelector('.fixed.inset-0.bg-gray-600.bg-opacity-50.z-50');
            if (existingModal) existingModal.remove(); // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            
            const messageBox = document.createElement('div');
            messageBox.classList.add('fixed', 'inset-0', 'bg-gray-600', 'bg-opacity-50', 'flex', 'items-center', 'justify-center', 'z-50');
            
            const colorClass = {
                'red': { header: 'text-red-600', button: 'bg-red-600 hover:bg-red-700' },
                'green': { header: 'text-green-600', button: 'bg-green-600 hover:bg-green-700' },
                'blue': { header: 'text-blue-600', button: 'bg-blue-600 hover:bg-blue-700' }
            }[color || 'blue'];
            
            const content = isHtml ? message : `<p class="text-gray-700 mb-6">${message}</p>`;

            messageBox.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-11/12 transform transition-all">
                    <h3 class="text-xl font-bold ${colorClass.header} mb-4">${title}</h3>
                    <div class="mb-6">${content}</div>
                    <button class="w-full px-4 py-2 ${colorClass.button} text-white font-semibold rounded-lg" onclick="this.parentNode.parentNode.remove()">ë‹«ê¸°</button>
                </div>
            `;
            document.body.appendChild(messageBox);
        }

        /** ì´í•©ê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
        function updateTotals() {
            const totalKcal = meals.reduce((sum, meal) => sum + meal.kcal, 0);
            const totalCarbs = meals.reduce((sum, meal) => sum + meal.carbs, 0);
            const totalProtein = meals.reduce((sum, meal) => sum + meal.protein, 0);
            const totalFat = meals.reduce((sum, meal) => sum + meal.fat, 0);

            totalKcalEl.textContent = totalKcal.toFixed(0);
            totalCarbsEl.textContent = totalCarbs.toFixed(0);
            totalProteinEl.textContent = totalProtein.toFixed(0);
            totalFatEl.textContent = totalFat.toFixed(0);
        }
        
        /** ë¯¸ì €ì¥ ì‹ë‹¨ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ */
        function renderMealList() {
            mealList.innerHTML = '';

            meals.forEach(meal => {
                const newRow = document.createElement('tr');
                if (editingMealId === meal.id) {
                    newRow.classList.add('bg-yellow-100', 'border-yellow-500', 'border');
                }
                newRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${meal.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${meal.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${meal.kcal}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${meal.carbs}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${meal.protein}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${meal.fat}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button type="button" onclick="window.editMeal(${meal.id})" class="text-indigo-600 hover:text-indigo-900">ìˆ˜ì •</button>
                        <button type="button" onclick="window.deleteMeal(${meal.id})" class="text-red-600 hover:text-red-900">ì‚­ì œ</button>
                    </td>
                `;
                mealList.appendChild(newRow);
            });
            
            if (meals.length === 0 && initialExampleRow) {
                initialExampleRow.style.display = 'table-row';
            } else if (initialExampleRow) {
                initialExampleRow.style.display = 'none';
            }
        }

        // --- 2. ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ (CRUD for current meals) ---

        /** ìˆ˜ì • ëª¨ë“œ ì§„ì… í•¨ìˆ˜ */
        window.editMeal = function(id) {
            editingMealId = id;
            const meal = meals.find(m => m.id === id);

            if (meal) {
                // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
                mealDateInput.value = meal.date;
                mealNameInput.value = meal.name;
                kcalInput.value = meal.kcal;
                carbsInput.value = meal.carbs;
                proteinInput.value = meal.protein;
                fatInput.value = meal.fat;

                // ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ìŠ¤íƒ€ì¼ ë³€ê²½
                submitButton.textContent = 'ë³€ê²½ ì‚¬í•­ ì €ì¥';
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                
                renderMealList(); // ìˆ˜ì • ì¤‘ì¸ í–‰ í•˜ì´ë¼ì´íŠ¸
                mealNameInput.focus();
            }
        }
        
        /** ì‹ë‹¨ ì‚­ì œ í™•ì¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ */
        window.deleteMeal = function(id) {
            const mealToDelete = meals.find(m => m.id === id);
            if (!mealToDelete) return;

            const messageHtml = `
                <p class="text-gray-700 mb-6">ì •ë§ë¡œ **${mealToDelete.name}** ì‹ë‹¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div class="flex justify-end space-x-3">
                    <button class="px-4 py-2 text-gray-700 font-semibold rounded-lg border border-gray-300 hover:bg-gray-100" onclick="this.parentNode.parentNode.parentNode.remove()">ì·¨ì†Œ</button>
                    <button class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700" onclick="window.confirmDelete(${id})">ì‚­ì œ</button>
                </div>
            `;
            showCustomAlert("ì‹ë‹¨ ì‚­ì œ í™•ì¸", messageHtml, "red", true);
        }
        
        /** ì‹ë‹¨ ì‚­ì œ ì‹¤í–‰ í•¨ìˆ˜ */
        window.confirmDelete = function(id) {
            // ëª¨ë‹¬ ë‹«ê¸°
            const messageBox = document.querySelector('.fixed.inset-0.bg-gray-600.bg-opacity-50');
            if (messageBox) messageBox.remove();
            
            meals = meals.filter(meal => meal.id !== id);

            // UI ì—…ë°ì´íŠ¸
            updateTotals();
            renderMealList();
            
            // ìˆ˜ì • ëª¨ë“œ í•´ì œ ë° í¼ ì´ˆê¸°í™”
            if (editingMealId === id) {
                editingMealId = null;
                submitButton.textContent = 'ì¶”ê°€';
                submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
                mealNameInput.value = '';
                kcalInput.value = '';
                carbsInput.value = '';
                proteinInput.value = '';
                fatInput.value = '';
                mealDateInput.valueAsDate = new Date(); 
            }
            
            setTimeout(() => { mealNameInput.focus(); }, 0);
        }

        // --- 3. Firebase ë° ê¸°ë¡ ê´€ë¦¬ í•¨ìˆ˜ ---

        /** Firebase ì´ˆê¸°í™” ë° ì¸ì¦ */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                document.getElementById('user-info').textContent = "Firebase ì„¤ì • ì˜¤ë¥˜";
                console.error("Firebase configuration is missing. Data saving/loading will not work.");
                isAuthReady = true; // ì¸ì¦ì´ í•„ìš” ì—†ëŠ” ìƒíƒœë¡œ ê°•ì œ ì „í™˜ (Firebase ê¸°ëŠ¥ë§Œ ë¹„í™œì„±í™”)
                return;
            }

            try {
                // setLogLevel('debug'); // ë””ë²„ê·¸ ë¡œê·¸ í•„ìš” ì‹œ í™œì„±í™”
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ìµëª… ì¸ì¦ ì‹œë„
                const userCredential = await signInAnonymously(auth);
                const currentUser = userCredential.user;
                
                if (currentUser) {
                    userId = currentUser.uid;
                } else {
                    // ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ì„ì‹œ ID ì‚¬ìš© ( Firestore ë³´ì•ˆ ê·œì¹™ì— ë”°ë¼ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
                    userId = 'local-anonymous-user-' + crypto.randomUUID(); 
                }
                
                isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", userId);
                document.getElementById('user-info').textContent = `ì‚¬ìš©ì ID: ${userId} (í´ë¼ìš°ë“œ ì—°ê²°ë¨)`;
                
                if (userId) {
                    fetchDailyRecords();
                }
                
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê²½ê³  ë° ë¡œì»¬ IDë¡œ ì „í™˜
                userId = 'local-anonymous-user-' + crypto.randomUUID();
                isAuthReady = true;
                document.getElementById('user-info').textContent = `Firebase ì˜¤ë¥˜. (ID: ${userId}) ë¡œì»¬ ì €ì¥ë§Œ ê°€ëŠ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                showCustomAlert("Firebase ì—°ê²° ì˜¤ë¥˜", "Firebase ì„¤ì • ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ í´ë¼ìš°ë“œ ë°ì´í„° ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.", "red");
            }
        }
        
        /** ì¼ì¼ ê¸°ë¡ ì»¬ë ‰ì…˜ ì°¸ì¡° ë°˜í™˜ */
        function getDailyRecordsCollectionRef() {
            if (!db || !userId || !firebaseConfig) return null;
            // Private collection path: /artifacts/{appId}/users/{userId}/daily_summaries
            return collection(db, 'artifacts', appId, 'users', userId, 'daily_summaries');
        }

        /** ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ìµœì¢… ì €ì¥ */
        window.saveDailyRecord = async function() {
            if (!isAuthReady) {
                showCustomAlert("ì €ì¥ ì˜¤ë¥˜", "ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "red");
                return;
            }
            if (meals.length === 0) {
                showCustomAlert("ì €ì¥ ì˜¤ë¥˜", "ì €ì¥í•  ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ì‹ë‹¨ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.", "red");
                return;
            }
            if (!firebaseConfig) {
                showCustomAlert("í´ë¼ìš°ë“œ ì €ì¥ ì˜¤ë¥˜", "Firebase ì„¤ì •ì´ ëˆ„ë½ë˜ì–´ í´ë¼ìš°ë“œ ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì½”ë“œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.", "red");
                return;
            }

            // ì´í•©ê³„ ê³„ì‚°
            const totals = {
                kcal: meals.reduce((sum, meal) => sum + meal.kcal, 0),
                carbs: meals.reduce((sum, meal) => sum + meal.carbs, 0),
                protein: meals.reduce((sum, meal) => sum + meal.protein, 0),
                fat: meals.reduce((sum, meal) => sum + meal.fat, 0),
            };
            
            const recordDate = mealDateInput.value;
            
            const record = {
                date: recordDate,
                timestamp: serverTimestamp(),
                totals: totals,
                meals: JSON.parse(JSON.stringify(meals)), // ê¹Šì€ ë³µì‚¬
            };
            
            const collectionRef = getDailyRecordsCollectionRef();
            if (!collectionRef) {
                showCustomAlert("ì˜¤ë¥˜", "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.", "red");
                return;
            }

            try {
                // ë‚ ì§œë¥¼ document IDë¡œ ì‚¬ìš©í•˜ì—¬ ë®ì–´ì“°ê¸° ë°©ì§€
                await setDoc(doc(collectionRef, recordDate), record);
                
                showCustomAlert("ì €ì¥ ì™„ë£Œ", `${recordDate}ì˜ ì‹ë‹¨ ê¸°ë¡ (${totals.kcal.toFixed(0)} Kcal)ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, "green");
                
                // ì €ì¥ í›„ í˜„ì¬ ì‹ë‹¨ ëª©ë¡ ì´ˆê¸°í™”
                meals = [];
                updateTotals();
                renderMealList();
                
            } catch (e) {
                console.error("Error saving document: ", e);
                showCustomAlert("ì €ì¥ ì‹¤íŒ¨", "ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (Firebase ë³´ì•ˆ ê·œì¹™ í™•ì¸ í•„ìš”)", "red");
            }
        }

        /** ì¼ì¼ ê¸°ë¡ ì‹¤ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸° */
        function fetchDailyRecords() {
            const collectionRef = getDailyRecordsCollectionRef();
            if (!collectionRef) return;

            // ë‚ ì§œ(date) ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            const q = query(collectionRef, orderBy("date", "desc"));

            onSnapshot(q, (snapshot) => {
                dailyRecords = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    dailyRecords.push({ id: doc.id, ...data }); 
                });
                renderDailyRecords();
            }, (error) => {
                console.error("Error fetching daily records:", error);
                document.getElementById('daily-records-list').innerHTML = `
                    <tr><td colspan="6" class="px-6 py-4 text-center text-red-500 italic">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${error.code}</td></tr>
                `;
            });
        }

        /** ì €ì¥ëœ ì¼ì¼ ê¸°ë¡ ëª©ë¡ ë Œë”ë§ */
        function renderDailyRecords() {
            const recordsListEl = document.getElementById('daily-records-list');
            recordsListEl.innerHTML = '';
            
            if (dailyRecords.length === 0) {
                recordsListEl.innerHTML = `
                    <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">ì €ì¥ëœ ì¼ì¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                `;
                return;
            }

            dailyRecords.forEach(record => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${record.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${record.totals.kcal.toFixed(0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${record.totals.carbs.toFixed(0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${record.totals.protein.toFixed(0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${record.totals.fat.toFixed(0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" onclick="window.viewDetails('${record.id}')" class="text-blue-600 hover:text-blue-900">ìƒì„¸ ë³´ê¸°</button>
                    </td>
                `;
                recordsListEl.appendChild(row);
            });
        }

        /** ìƒì„¸ ê¸°ë¡ ë³´ê¸° */
        window.viewDetails = function(recordId) {
            const record = dailyRecords.find(r => r.id === recordId);
            if (!record) return;

            let mealDetailsHtml = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">${record.date} ìƒì„¸ ì‹ë‹¨ ê¸°ë¡</h3>
                <p class="mb-4 text-sm text-gray-600">
                    <span class="font-bold text-blue-600">Kcal ${record.totals.kcal.toFixed(0)}</span> | 
                    íƒ„ìˆ˜ ${record.totals.carbs.toFixed(0)}g | 
                    ë‹¨ë°± ${record.totals.protein.toFixed(0)}g | 
                    ì§€ë°© ${record.totals.fat.toFixed(0)}g
                </p>
                <div class="overflow-y-auto max-h-64 border rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">ì‹ë‹¨ëª…</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Kcal</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">íƒ„ (g)</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">ë‹¨ (g)</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">ì§€ (g)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            record.meals.forEach(meal => {
                mealDetailsHtml += `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${meal.name}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">${meal.kcal}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">${meal.carbs}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">${meal.protein}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">${meal.fat}</td>
                    </tr>
                `;
            });
            
            mealDetailsHtml += `
                    </tbody>
                </table>
                </div>
            `;

            showCustomAlert(`${record.date} ìƒì„¸ ê¸°ë¡`, mealDetailsHtml, "blue", true);
        }

        // --- 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™” ---

        // í¼ ì œì¶œ í•¸ë“¤ëŸ¬ (ì¶”ê°€/ìˆ˜ì • ë¡œì§)
        mealForm.addEventListener('submit', function(event) {
            event.preventDefault();

            if (!isAuthReady) {
                showCustomAlert("ì˜¤ë¥˜", "ì‚¬ìš©ì ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "red");
                return;
            }

            const newMealData = {
                date: mealDateInput.value,
                name: mealNameInput.value.trim(),
                kcal: parseFloat(kcalInput.value) || 0,
                carbs: parseFloat(carbsInput.value) || 0,
                protein: parseFloat(proteinInput.value) || 0,
                fat: parseFloat(fatInput.value) || 0,
            };
            
            if (!newMealData.name) {
                showCustomAlert("ì…ë ¥ ì˜¤ë¥˜", "ì‹ë‹¨ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "red");
                mealNameInput.focus();
                return;
            }


            if (editingMealId) {
                const index = meals.findIndex(m => m.id === editingMealId);
                if (index !== -1) {
                    meals[index] = { ...meals[index], ...newMealData }; 
                }

                editingMealId = null;
                submitButton.textContent = 'ì¶”ê°€';
                submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');

            } else {
                newMealData.id = Date.now(); 
                meals.push(newMealData);
            }

            updateTotals();
            renderMealList();

            mealNameInput.value = '';
            kcalInput.value = '';
            carbsInput.value = '';
            proteinInput.value = '';
            fatInput.value = '';

            setTimeout(() => { mealNameInput.focus(); }, 0);
        });
        
        // ì´ˆê¸°í™”
        initializeFirebase();
        updateTotals();
        renderMealList();
        
    </script>

</body>
</html>
