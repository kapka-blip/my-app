<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì¼ ì‹ë‹¨ ìë™ ê³„ì‚°ê¸° (UI ê°œì„  ë° ê²Œì‹œíŒ ì¶”ê°€)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ì˜ì–‘ì†Œ ê°•ì¡° ìƒ‰ìƒ ì¶”ê°€
                        'kcal-color': '#EF4444', // Red-500
                        'carbs-color': '#F59E0B', // Amber-500
                        'protein-color': '#10B981', // Emerald-500
                        'fat-color': '#3B82F6', // Blue-500
                        'board-color': '#EC4899', // Pink-500
                    }
                }
            }
        }
    </script>

    <script type="module">
        // 1. í•„ìš”í•œ í•¨ìˆ˜ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // deleteDoc í•¨ìˆ˜ ì¶”ê°€
        import { getFirestore, doc, getDoc, setDoc, collection, query, getDocs, where, documentId, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCjTyTrnhFuGV8PVd3mtMj9zQd7DFX4J3s",
            authDomain: "meal-tracker-f2644.firebaseapp.com",
            projectId: "meal-tracker-f2644",
            storageBucket: "meal-tracker-f2644.appspot.com", 
            messagingSenderId: "739384992411",
            appId: "1:739384992411:web:1e47f734197cd6dff89c3e"
        };
        
        // â­ï¸â­ï¸â­ï¸ 3. ID ê³ ì • ë³€ìˆ˜ ì„¤ì • â­ï¸â­ï¸â­ï¸
        const HARDCODED_USER_ID = "cDvRxKkPIXP0IG8ffu4UcCpagX53";
        // â­ï¸â­ï¸â­ï¸ ----------------------------- â­ï¸â­ï¸â­ï¸

        const appId = firebaseConfig.projectId; 

        let app, db, auth, userId = null;

        // 4. ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.setPersistence = setPersistence;
        window.browserLocalPersistence = browserLocalPersistence;
        window.where = where;
        window.documentId = documentId;
        window.deleteDoc = deleteDoc; // deleteDoc í•¨ìˆ˜ ì¶”ê°€
        
        // 5. ì¸ìŠ¤í„´ìŠ¤/ì„¤ì • ë°˜í™˜ ë° ID ê´€ë¦¬ í•¨ìˆ˜
        window.setUserId = (id) => { userId = id; };
        window.getHardcodedId = () => HARDCODED_USER_ID; 
        window.getFirebaseInstances = () => ({ appId, db, auth, userId, config: firebaseConfig });
    </script>
    
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        /* ìˆ«ì ì…ë ¥ í•„ë“œì˜ ìŠ¤í”¼ë„ˆ ì œê±° */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        /* ë³´ê³ ì„œ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        #report-content::-webkit-scrollbar,
        #community-main-content::-webkit-scrollbar { width: 8px; }
        #report-content::-webkit-scrollbar-thumb,
        #community-main-content::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        #report-content::-webkit-scrollbar-track,
        #community-main-content::-webkit-scrollbar-track { background: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-4xl">
        
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-4">
            ì¼ì¼ ì‹ë‹¨ ìë™ ê³„ì‚°ê¸° (ê³µìœ ìš©)
        </h1>

        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-daily-input" onclick="switchView('daily-input')"
                    class="px-4 py-2 text-sm sm:text-base font-medium rounded-t-lg transition-colors duration-150 border-b-2 border-indigo-500 text-indigo-600">
                ì¼ì¼ ì…ë ¥
            </button>
            <button id="tab-report" onclick="switchView('report')"
                    class="px-4 py-2 text-sm sm:text-base font-medium rounded-t-lg transition-colors duration-150 border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-500">
                ì €ì¥ ê¸°ë¡ ì¡°íšŒ
            </button>
            <button id="tab-community" onclick="switchView('community')"
                    class="px-4 py-2 text-sm sm:text-base font-medium rounded-t-lg transition-colors duration-150 border-b-2 border-transparent text-gray-500 hover:text-board-color hover:border-board-color">
                ë‹¤ì´ì–´íŠ¸ ì •ë³´ ê²Œì‹œíŒ
            </button>
        </div>

        <div id="auth-status-message" class="text-center p-3 mb-4 rounded-lg text-sm transition-opacity duration-300 bg-red-100 text-red-600">
            ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘...
        </div>
        
        <div id="view-container">
            
            <div id="daily-input-view" class="space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 rounded-xl shadow-inner">
                    <div class="mb-2 sm:mb-0">
                        <label for="meal-date" class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ ì„ íƒ:</label>
                        <input type="date" id="meal-date" class="p-2 border border-gray-300 rounded-lg w-full sm:w-auto shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="text-xs text-gray-500 text-right w-full sm:w-auto">
                        <span class="font-semibold">ì‚¬ìš©ì ID (ê³ ì •ëœ ê³µìœ  ID):</span>
                        <p id="user-id-display" class="break-all mt-1"></p>
                    </div>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-indigo-800 mb-4">ì‹ë‹¨ ì…ë ¥</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-6 gap-3">
                        <input type="text" id="meal-name" placeholder="ì‹ë‹¨ëª… (ì˜ˆ: ì•„ì¹¨ ì‹ì‚¬)" class="col-span-2 p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md" required>
                        <input type="number" id="meal-kcal" placeholder="Kcal" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md" required>
                        <input type="number" id="meal-carbs" placeholder="íƒ„ìˆ˜í™”ë¬¼(g)" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md">
                        <input type="number" id="meal-protein" placeholder="ë‹¨ë°±ì§ˆ(g)" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md">
                        <input type="number" id="meal-fat" placeholder="ì§€ë°©(g)" class="p-3 border border-indigo-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-shadow shadow-md">
                    </div>
                    <button id="add-meal-button"
                            class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition-colors duration-200 font-bold shadow-lg transform hover:scale-[1.01]">
                        + ì‹ë‹¨ ì¶”ê°€
                    </button>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ëª©ë¡</h2>
                    <div id="meals-list" class="space-y-3">
                        <p class="text-gray-500 text-center p-4" id="no-meals-message">ì¶”ê°€ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>

                    <div id="totals" class="bg-white border-2 border-green-500 p-4 rounded-xl shadow-lg font-bold text-gray-800">
                        <h3 class="text-xl sm:text-2xl mb-3 text-green-700">âœ… ì´ í•©ê³„</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                            <div class="bg-red-50 p-2 rounded-lg">
                                <p class="text-sm text-red-600 font-medium">Kcal</p>
                                <p id="total-kcal" class="text-3xl text-red-700">0</p>
                            </div>
                            <div class="bg-yellow-50 p-2 rounded-lg">
                                <p class="text-sm text-yellow-600 font-medium">íƒ„ìˆ˜í™”ë¬¼(g)</p>
                                <p id="total-carbs" class="text-3xl text-yellow-700">0</p>
                            </div>
                            <div class="bg-emerald-50 p-2 rounded-lg">
                                <p class="text-sm text-emerald-600 font-medium">ë‹¨ë°±ì§ˆ(g)</p>
                                <p id="total-protein" class="text-3xl text-emerald-700">0</p>
                            </div>
                            <div class="bg-blue-50 p-2 rounded-lg">
                                <p class="text-sm text-blue-600 font-medium">ì§€ë°©(g)</p>
                                <p id="total-fat" class="text-3xl text-blue-700">0</p>
                            </div>
                        </div>
                    </div>

                    <button id="save-button"
                            class="w-full bg-green-600 text-white py-3 rounded-xl hover:bg-green-700 transition-colors duration-200 font-bold shadow-lg transform hover:scale-[1.01]">
                        ì˜¤ëŠ˜ì˜ ì‹ë‹¨ ì €ì¥
                    </button>
                </div>
            </div>

            <div id="report-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">ì‹ë‹¨ ì €ì¥ ê¸°ë¡</h2>
                
                <div class="bg-yellow-50 p-4 rounded-xl shadow-inner border-l-4 border-yellow-500">
                    <h3 class="text-lg font-semibold text-yellow-800 mb-2">ğŸ¤ ê³µìœ  ê¸°ë¡ ì¡°íšŒ</h3>
                    <div class="flex gap-2">
                        <input type="text" id="friend-user-id" placeholder="IDë¥¼ ì…ë ¥í•´ë„ ê³ ì •ëœ IDì˜ ê¸°ë¡ë§Œ ì¡°íšŒë©ë‹ˆë‹¤." 
                               class="p-2 border border-yellow-300 rounded-lg w-full shadow-sm text-sm focus:ring-yellow-500 focus:border-yellow-500">
                        <button id="self-search-button"
                                class="bg-gray-300 text-gray-700 py-2 px-4 rounded-xl hover:bg-gray-400 transition-colors duration-200 font-medium shadow-md flex-shrink-0 text-sm">
                            ê³ ì • ID ì¡°íšŒ
                        </button>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 items-center bg-gray-50 p-4 rounded-xl shadow-inner">
                    <div class="flex-1 w-full">
                        <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼:</label>
                        <input type="date" id="report-start-date" class="p-2 border border-gray-300 rounded-lg w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex-1 w-full">
                        <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì¼:</label>
                        <input type="date" id="report-end-date" class="p-2 border border-gray-300 rounded-lg w-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button id="report-search-button" 
                            class="w-full sm:w-auto bg-blue-500 text-white py-2 px-6 rounded-xl hover:bg-blue-600 transition-colors duration-200 font-medium shadow-md self-end sm:mt-6">
                        ê¸°ë¡ ì¡°íšŒ
                    </button>
                </div>
                <div id="report-content" class="bg-white rounded-xl shadow-inner p-4 max-h-[60vh] overflow-y-auto">
                    <p class="text-gray-500 text-center p-10" id="report-loading-message">
                        ì €ì¥ëœ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </p>
                </div>
            </div>

            <div id="community-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">ë‹¤ì´ì–´íŠ¸ ì •ë³´ ê²Œì‹œíŒ</h2>
                <div id="community-main-content" class="min-h-[50vh] bg-gray-50 p-4 rounded-xl shadow-inner overflow-y-auto">
                    <p class="text-gray-500 text-center p-10">ê²Œì‹œíŒ ë¡œë“œ ì¤‘...</p>
                </div>
            </div>
            
        </div>
        
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="document.getElementById('modal-container').classList.add('hidden');">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-100" onclick="event.stopPropagation();">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">ì œëª©</h3>
            <p id="modal-message" class="text-gray-700 mb-4">ë©”ì‹œì§€ ë‚´ìš©</p>
            <button onclick="document.getElementById('modal-container').classList.add('hidden');"
                    class="w-full bg-indigo-600 text-white py-2 rounded-xl hover:bg-indigo-700 transition-colors duration-200 font-medium">
                í™•ì¸
            </button>
        </div>
    </div>


    <script>
        // ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ì„¤ì • (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        let meals = [];
        const mealInput = {
            date: document.getElementById('meal-date'),
            name: document.getElementById('meal-name'),
            kcal: document.getElementById('meal-kcal'),
            carbs: document.getElementById('meal-carbs'),
            protein: document.getElementById('meal-protein'),
            fat: document.getElementById('meal-fat'),
            addButton: document.getElementById('add-meal-button'),
        };
        const saveButton = document.getElementById('save-button');
        const mealsList = document.getElementById('meals-list');
        const noMealsMessage = document.getElementById('no-meals-message');
        const totalsDisplay = {
            kcal: document.getElementById('total-kcal'),
            carbs: document.getElementById('total-carbs'),
            protein: document.getElementById('total-protein'),
            fat: document.getElementById('total-fat'),
        };
        const friendIdInput = document.getElementById('friend-user-id'); 
        const reportSearchButton = document.getElementById('report-search-button');
        const selfSearchButton = document.getElementById('self-search-button');
        
        // â­ï¸ NEW DOM ELEMENT: ê²Œì‹œíŒ â­ï¸
        const communityMainContent = document.getElementById('community-main-content');
        let currentEditingPost = null; // ìˆ˜ì • ì¤‘ì¸ ê²Œì‹œë¬¼ ID

        let db, auth, userId, appId;

        // ì—ëŸ¬ ë˜ëŠ” ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        function showModal(title, message, isError = false) {
            const container = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            if (isError) {
                modalTitle.classList.remove('text-green-600');
                modalTitle.classList.add('text-red-600');
            } else {
                modalTitle.classList.remove('text-red-600');
                modalTitle.classList.add('text-green-600');
            }

            container.classList.remove('hidden');
        }

        // Firebase ì´ˆê¸°í™” í•¨ìˆ˜ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        async function initializeFirebase() {
            try {
                const instances = window.getFirebaseInstances();
                appId = instances.appId; 
                const firebaseConfig = instances.config; 
                const HARDCODED_USER_ID = window.getHardcodedId();
                
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
                
                const app = window.initializeApp(firebaseConfig);
                db = window.getFirestore(app);
                auth = window.getAuth(app);

                await window.setPersistence(auth, window.browserLocalPersistence);

                try {
                    await window.signInAnonymously(auth);
                } catch (authError) {
                    await window.signInAnonymously(auth);
                }


                window.onAuthStateChanged(auth, (user) => {
                    const statusMessage = document.getElementById('auth-status-message');
                    const userIdDisplay = document.getElementById('user-id-display');

                    if (user) {
                        userId = HARDCODED_USER_ID;
                        window.setUserId(userId);
                        
                        userIdDisplay.textContent = userId;
                        
                        statusMessage.classList.remove('bg-red-100', 'text-red-600', 'bg-yellow-100', 'text-yellow-600');
                        statusMessage.classList.add('bg-green-100', 'text-green-600');
                        statusMessage.textContent = `âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì™„ë£Œ (Target ID: ${userId.substring(0, 8)}...)`;

                        loadMealsForDate(mealInput.date.value);
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'ì¸ì¦ ì‹¤íŒ¨';
                        statusMessage.classList.remove('bg-green-100', 'text-green-600', 'bg-yellow-100', 'text-yellow-600');
                        statusMessage.classList.add('bg-red-100', 'text-red-600');
                        statusMessage.textContent = `âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ì¸ì¦ ë¶ˆê°€`;
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                document.getElementById('auth-status-message').textContent = `âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                document.getElementById('auth-status-message').classList.remove('bg-green-100', 'text-green-600', 'bg-yellow-100', 'text-yellow-600');
                document.getElementById('auth-status-message').classList.add('bg-red-100', 'text-red-600');
                db = null; 
            }
        }
        
        // Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ ìƒì„± í•¨ìˆ˜ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        function getCollectionPath() {
            const id = window.getHardcodedId(); 
            if (!id) {
                console.error("Target User ID is not defined.");
                return null;
            }
            return `/artifacts/${appId}/users/${id}/daily_meals`;
        }
        
        // â­ï¸ NEW FUNCTION: ê²Œì‹œíŒ ì»¬ë ‰ì…˜ ê²½ë¡œ (Public Collection) â­ï¸
        function getCommunityCollectionPath() {
            return `/artifacts/${appId}/public/data/community_posts`;
        }
        
        // í˜„ì¬ ë‚ ì§œì˜ ì‹ë‹¨ ë°ì´í„° ë¡œë“œ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        async function loadMealsForDate(date) {
            meals = []; 
            renderMeals(); 
            
            if (!db || !userId) {
                return;
            }

            try {
                const collectionPath = getCollectionPath();
                if (!collectionPath) return;

                const docRef = window.doc(db, collectionPath, date);
                const docSnap = await window.getDoc(docRef);

                if (docSnap.exists()) {
                    meals = docSnap.data().meals || [];
                } else {
                    meals = [];
                }
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                meals = [];
            }
            renderMeals();
        }

        // â­ï¸ UI ê°œì„ : ì‹ë‹¨ ëª©ë¡ ë Œë”ë§ â­ï¸
        function renderMeals() {
            mealsList.innerHTML = '';
            
            let totalKcal = 0;
            let totalCarbs = 0;
            let totalProtein = 0;
            let totalFat = 0;

            if (meals.length === 0) {
                noMealsMessage.classList.remove('hidden');
                mealsList.appendChild(noMealsMessage);
            } else {
                noMealsMessage.classList.add('hidden');

                meals.forEach((meal, index) => {
                    const mealItem = document.createElement('div');
                    mealItem.className = 'grid grid-cols-6 items-center p-3 bg-white rounded-xl shadow-md border-l-4 border-indigo-400';
                    mealItem.innerHTML = `
                        <div class="col-span-6 sm:col-span-2 flex-grow mb-2 sm:mb-0">
                            <p class="font-bold text-gray-800 text-base">${meal.name}</p>
                        </div>
                        
                        <div class="col-span-3 sm:col-span-3 grid grid-cols-4 gap-2 text-center text-sm">
                            <p class="font-bold text-kcal-color text-lg flex items-center justify-center">
                                <span class="hidden sm:inline">ğŸ”¥</span> ${meal.kcal}
                            </p>
                            <p class="font-bold text-carbs-color text-lg flex items-center justify-center">
                                <span class="hidden sm:inline">ğŸš</span> ${meal.carbs}
                            </p>
                            <p class="font-bold text-protein-color text-lg flex items-center justify-center">
                                <span class="hidden sm:inline">ğŸ—</span> ${meal.protein}
                            </p>
                            <p class="font-bold text-fat-color text-lg flex items-center justify-center">
                                <span class="hidden sm:inline">ğŸ§ˆ</span> ${meal.fat}
                            </p>
                        </div>
                        
                        <div class="col-span-3 sm:col-span-1 flex justify-end space-x-2">
                            <button onclick="window.editMeal(${index})" 
                                    class="text-blue-500 hover:text-blue-700 transition-colors p-1 rounded-full text-base font-medium">
                                ìˆ˜ì •
                            </button>
                            <button onclick="window.removeMeal(${index})" 
                                    class="text-red-500 hover:text-red-700 transition-colors p-1 rounded-full text-base font-medium">
                                ì‚­ì œ
                            </button>
                        </div>
                    `;
                    mealsList.appendChild(mealItem);

                    totalKcal += meal.kcal;
                    totalCarbs += meal.carbs;
                    totalProtein += meal.protein;
                    totalFat += meal.fat;
                });
            }

            totalsDisplay.kcal.textContent = totalKcal;
            totalsDisplay.carbs.textContent = totalCarbs;
            totalsDisplay.protein.textContent = totalProtein;
            totalsDisplay.fat.textContent = totalFat;
        }

        // ì‹ë‹¨ ìˆ˜ì • í•¨ìˆ˜ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        window.editMeal = function(index) {
            if (index < 0 || index >= meals.length) return;
            const mealToEdit = meals[index];
            mealInput.name.value = mealToEdit.name;
            mealInput.kcal.value = mealToEdit.kcal;
            mealInput.carbs.value = mealToEdit.carbs;
            mealInput.protein.value = mealToEdit.protein;
            mealInput.fat.value = mealToEdit.fat;
            mealInput.name.focus();
            window.removeMeal(index);
            showModal("ìˆ˜ì • ëª¨ë“œ", `${mealToEdit.name} í•­ëª©ì´ ì…ë ¥ í•„ë“œì— ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ìˆ˜ì •í•œ í›„ [+ ì‹ë‹¨ ì¶”ê°€] ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”.`, false);
        }

        // ì‹ë‹¨ ì¶”ê°€ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        window.addMeal = function() {
            const name = mealInput.name.value.trim();
            const kcal = parseInt(mealInput.kcal.value) || 0;
            const carbs = parseInt(mealInput.carbs.value) || 0;
            const protein = parseInt(mealInput.protein.value) || 0;
            const fat = parseInt(mealInput.fat.value) || 0;

            if (!name || kcal <= 0) {
                showModal("ì…ë ¥ ì˜¤ë¥˜", "ì‹ë‹¨ëª…ê³¼ 0 ì´ìƒì˜ ì¹¼ë¡œë¦¬(Kcal)ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤.", true);
                return;
            }

            const newMeal = {
                name,
                kcal,
                carbs,
                protein,
                fat,
                timestamp: new Date().toISOString()
            };

            meals.push(newMeal);
            renderMeals();

            mealInput.name.value = '';
            mealInput.kcal.value = '';
            mealInput.carbs.value = '';
            mealInput.protein.value = '';
            mealInput.fat.value = '';
            mealInput.name.focus();
        }

        // ì‹ë‹¨ ì‚­ì œ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        window.removeMeal = function(index) {
            meals.splice(index, 1);
            renderMeals();
        }

        // ì‹ë‹¨ ì €ì¥ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        async function saveTodaysMeals() {
            if (!db || !userId) {
                showModal("ì €ì¥ ì˜¤ë¥˜", "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", true);
                return;
            }

            const date = mealInput.date.value;
            if (!date) {
                showModal("ì €ì¥ ì˜¤ë¥˜", "ì €ì¥í•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", true);
                return;
            }
            
            const collectionPath = getCollectionPath(); 
            if (!collectionPath) return;

            const dataToSave = {
                meals: meals,
                totalKcal: parseInt(totalsDisplay.kcal.textContent),
                totalCarbs: parseInt(totalsDisplay.carbs.textContent),
                totalProtein: parseInt(totalsDisplay.protein.textContent),
                totalFat: parseInt(totalsDisplay.fat.textContent),
                lastUpdated: new Date().toISOString()
            };

            try {
                const docRef = window.doc(db, collectionPath, date);
                await window.setDoc(docRef, dataToSave);

                showModal("ì €ì¥ ì™„ë£Œ", `${date}ì˜ ì‹ë‹¨ ${meals.length}ê°œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, false);
                
            } catch (error) {
                console.error("ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:", error);
                showModal("ë°ì´í„° ì €ì¥ ì˜¤ë¥˜", `ì‹ë‹¨ì„ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}. (Firestore ê·œì¹™ì˜ write ê¶Œí•œì„ í™•ì¸í•´ ë³´ì„¸ìš”)`, true);
            }
        }


        // ë·° ì „í™˜ ê¸°ëŠ¥ (ê²Œì‹œíŒ íƒ­ ì¶”ê°€)
        window.switchView = function(viewName) {
            const views = {
                'daily-input': document.getElementById('daily-input-view'),
                'report': document.getElementById('report-view'),
                'community': document.getElementById('community-view') // NEW
            };
            const tabs = {
                'daily-input': document.getElementById('tab-daily-input'),
                'report': document.getElementById('tab-report'),
                'community': document.getElementById('tab-community') // NEW
            };

            const allViews = Object.values(views);
            const allTabs = Object.values(tabs);

            allViews.forEach(v => v.classList.add('hidden'));
            allTabs.forEach(t => {
                t.classList.remove('border-indigo-500', 'text-indigo-600', 'border-board-color', 'text-board-color');
                t.classList.add('border-transparent', 'text-gray-500');
            });


            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                
                if (viewName === 'community') {
                    tabs[viewName].classList.add('border-board-color', 'text-board-color');
                    window.renderCommunityView();
                } else {
                    tabs[viewName].classList.add('border-indigo-500', 'text-indigo-600');
                    if (viewName === 'daily-input') loadMealsForDate(mealInput.date.value);
                    else if (viewName === 'report') renderReport();
                }
            }
        }

        // UI ê°œì„ : ë³´ê³ ì„œ ë Œë”ë§ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        window.renderReport = async function() {
            const reportContent = document.getElementById('report-content');
            const loadingMessage = document.getElementById('report-loading-message');
            
            reportContent.innerHTML = ''; 
            loadingMessage.textContent = "ì €ì¥ëœ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            loadingMessage.classList.remove('hidden', 'text-red-500'); 
            loadingMessage.classList.add('text-gray-500');
            reportContent.appendChild(loadingMessage);

            const HARDCODED_USER_ID = window.getHardcodedId();
            const targetUserId = HARDCODED_USER_ID; 
            
            const displayUserId = targetUserId ? targetUserId.substring(0, 8) + '...' : 'ID ì—†ìŒ';
            const viewTitle = `ê³µìœ  ID (${displayUserId})ì˜ ê¸°ë¡`;

            const startDate = document.getElementById('report-start-date')?.value;
            const endDate = document.getElementById('report-end-date')?.value;

            if (!startDate || !endDate || startDate > endDate || !db || !targetUserId) {
                 if (!startDate || !endDate) loadingMessage.textContent = `${viewTitle}: ì¡°íšŒí•  ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`;
                 else if (startDate > endDate) loadingMessage.textContent = `${viewTitle}: ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì´ì „ ë‚ ì§œì—¬ì•¼ í•©ë‹ˆë‹¤.`;
                 else loadingMessage.textContent = `âŒ ${viewTitle}: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨ ë˜ëŠ” ì‚¬ìš©ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                loadingMessage.classList.add('text-red-500');
                return;
            }

            try {
                const collectionPath = getCollectionPath();
                if (!collectionPath) return;

                const q = window.query(
                    window.collection(db, collectionPath),
                    window.where(window.documentId(), '>=', startDate),
                    window.where(window.documentId(), '<=', endDate)
                );
                
                const querySnapshot = await window.getDocs(q);

                const reportData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    reportData.push({ date: doc.id, ...data });
                });

                reportData.sort((a, b) => b.date.localeCompare(a.date));

                loadingMessage.classList.add('hidden');

                if (reportData.length === 0) {
                    reportContent.innerHTML += `<p class="text-gray-500 text-center p-10">${viewTitle}: í•´ë‹¹ ê¸°ê°„ì— ì €ì¥ëœ ì‹ë‹¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }
                
                reportContent.innerHTML += `<h3 class="text-xl font-bold text-gray-700 mb-4">${viewTitle}</h3>`;

                reportData.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'bg-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-blue-500';

                    const totalMeals = day.meals ? day.meals.length : 0;
                    const totalKcal = day.totalKcal || 0;
                    const totalCarbs = day.totalCarbs || 0;
                    const totalProtein = day.totalProtein || 0;
                    const totalFat = day.totalFat || 0;

                    let mealListHtml = '';
                    if (day.meals && day.meals.length > 0) {
                        mealListHtml = day.meals.map(meal => `
                             <li class="grid grid-cols-6 items-center text-sm ml-4 border-b border-gray-100 py-1">
                                <span class="col-span-2 text-gray-700 font-medium">${meal.name}</span>
                                <span class="col-span-1 text-kcal-color font-bold text-center">${meal.kcal} Kcal</span>
                                <span class="col-span-1 text-carbs-color font-bold text-center">${meal.carbs}g</span>
                                <span class="col-span-1 text-protein-color font-bold text-center">${meal.protein}g</span>
                                <span class="col-span-1 text-fat-color font-bold text-center">${meal.fat}g</span>
                            </li>
                        `).join('');
                    } else {
                        mealListHtml = '<li class="text-sm text-gray-500 ml-4">ì´ë‚ ì€ ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    }

                    dayElement.innerHTML = `
                        <h3 class="text-2xl font-extrabold text-blue-700 mb-4 border-b pb-2">${day.date}</h3>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-center text-base font-bold text-gray-600 mb-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-gray-700">ì´ ì‹ë‹¨: <span class="text-blue-600">${totalMeals}ê±´</span></p>
                            <p class="text-kcal-color">Kcal: <span>${totalKcal}</span></p>
                            <p class="text-carbs-color">íƒ„: <span>${totalCarbs}g</span></p>
                            <p class="text-protein-color">ë‹¨: <span>${totalProtein}g</span></p>
                            <p class="text-fat-color">ì§€: <span>${totalFat}g</span></p>
                        </div>
                        
                        <h4 class="font-semibold text-gray-700 mb-2 mt-4 border-t pt-2">ìƒì„¸ ì‹ë‹¨ í•­ëª©:</h4>
                        <ul class="space-y-1">${mealListHtml}</ul>
                    `;
                    reportContent.appendChild(dayElement);
                });

            } catch (error) {
                console.error("ë³´ê³ ì„œ ì¡°íšŒ ì˜¤ë¥˜:", error);
                reportContent.innerHTML += `<p class="text-red-500 text-center p-10">
                    âŒ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                    <br><br>
                    (Firebase ê·œì¹™ì´ **read, write: if request.auth != null;** ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.)
                </p>`;
            }
        }
        
        // â­ï¸ NEW FUNCTION: ê²Œì‹œíŒ ë¡œì§ â­ï¸

        // 1. ê²Œì‹œíŒ ë©”ì¸ ë·° ë Œë”ë§ (ê²Œì‹œë¬¼ ëª©ë¡ í‘œì‹œ)
        window.renderCommunityView = async function() {
            communityMainContent.innerHTML = `<p class="text-gray-500 text-center p-10">ê²Œì‹œë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            currentEditingPost = null;

            if (!db) {
                communityMainContent.innerHTML = `<p class="text-red-500 text-center p-10">ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
                return;
            }
            
            try {
                const colRef = window.collection(db, getCommunityCollectionPath());
                // ì œëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (idëŠ” ë‚ ì§œ ê¸°ì¤€ì´ ì•„ë‹ˆë¯€ë¡œ timestamp ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
                const querySnapshot = await window.getDocs(colRef);
                
                const posts = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    posts.push({ id: doc.id, ...data });
                });

                // timestamp ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ê¸€ì´ ìœ„ë¡œ)
                posts.sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || ''));

                let postListHtml = `
                    <div class="flex justify-between items-center mb-6 border-b pb-3">
                        <p class="text-lg font-bold text-board-color">${posts.length}ê°œì˜ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤.</p>
                        <button onclick="window.openPostForm()" 
                                class="bg-board-color text-white py-2 px-4 rounded-lg hover:bg-pink-700 transition-colors font-medium shadow-md">
                            + ìƒˆ ê¸€ ì‘ì„±
                        </button>
                    </div>
                    <div class="space-y-3">
                `;

                if (posts.length === 0) {
                    postListHtml += `<p class="text-gray-500 text-center p-10">ì‘ì„±ëœ ê²Œì‹œë¬¼ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>`;
                } else {
                    posts.forEach(post => {
                        const authorId = post.authorId ? post.authorId.substring(0, 8) + '...' : 'ìµëª…';
                        const date = post.timestamp ? new Date(post.timestamp).toLocaleString() : 'ë‚ ì§œ ë¶ˆëª…';
                        
                        postListHtml += `
                            <div onclick="window.renderPostDetail('${post.id}')"
                                class="p-4 bg-white rounded-lg shadow-md hover:shadow-lg transition duration-150 cursor-pointer border-l-4 border-board-color hover:bg-pink-50">
                                <p class="font-extrabold text-xl text-gray-800">${post.title}</p>
                                <p class="text-xs text-gray-500 mt-2">
                                    <span class="font-semibold text-gray-600">ì‘ì„±ì:</span> ${authorId}
                                    <span class="ml-4 font-semibold text-gray-600">ì‘ì„±ì¼:</span> ${date}
                                </p>
                            </div>
                        `;
                    });
                }
                
                postListHtml += `</div>`;
                communityMainContent.innerHTML = postListHtml;

            } catch (error) {
                console.error("ê²Œì‹œë¬¼ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
                communityMainContent.innerHTML = `<p class="text-red-500 text-center p-10">ê²Œì‹œë¬¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            }
        }
        
        // 2. ê²Œì‹œë¬¼ ìƒì„¸ ë³´ê¸°
        window.renderPostDetail = async function(postId) {
            communityMainContent.innerHTML = `<p class="text-gray-500 text-center p-10">ê²Œì‹œë¬¼ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            
            try {
                const docRef = window.doc(db, getCommunityCollectionPath(), postId);
                const docSnap = await window.getDoc(docRef);

                if (docSnap.exists()) {
                    const post = { id: docSnap.id, ...docSnap.data() };
                    const authorIdDisplay = post.authorId ? post.authorId.substring(0, 8) + '...' : 'ìµëª…';
                    const fullAuthorId = post.authorId || 'ìµëª…';
                    const dateDisplay = post.timestamp ? new Date(post.timestamp).toLocaleString() : 'ë‚ ì§œ ë¶ˆëª…';

                    // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì€ í˜„ì¬ ë¡œê·¸ì¸ëœ ID(ê³ ì • ID)ì™€ ì‘ì„±ì IDê°€ ì¼ì¹˜í•  ë•Œë§Œ í‘œì‹œ
                    const isAuthor = (fullAuthorId === userId);
                    
                    // â­ï¸ ìˆ˜ì •ëœ ë¶€ë¶„: post ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì „ë‹¬ â­ï¸
                    const postJsonString = JSON.stringify(post).replace(/"/g, '&quot;');
                    
                    const detailHtml = `
                        <div class="space-y-4">
                            <button onclick="window.renderCommunityView()" 
                                    class="text-blue-600 hover:text-blue-800 font-medium mb-4 flex items-center">
                                <span style="font-size: 1.5rem; line-height: 1;">&larr;</span>&nbsp; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                            </button>
                            
                            <div class="p-6 bg-white rounded-xl shadow-xl space-y-4 border-t-4 border-board-color">
                                <h3 class="text-3xl font-extrabold text-board-color break-words">${post.title}</h3>
                                <p class="text-sm text-gray-500 border-b pb-2">
                                    <span class="font-semibold text-gray-700">ì‘ì„±ì:</span> ${authorIdDisplay} 
                                    <span class="ml-4 font-semibold text-gray-700">ì‘ì„±ì¼:</span> ${dateDisplay}
                                </p>
                                <div class="bg-gray-50 p-6 rounded-lg text-gray-800 text-base leading-relaxed whitespace-pre-wrap shadow-inner min-h-[200px]">
                                    ${post.content.replace(/\n/g, '<br>')}
                                </div>
                                
                                <div class="flex justify-end space-x-3 pt-4">
                                    ${isAuthor ? `
                                        <button onclick="window.openPostForm('${postJsonString}')" 
                                                class="bg-blue-500 text-white py-2 px-4 rounded-xl hover:bg-blue-600 transition-colors font-medium">
                                            ìˆ˜ì •
                                        </button>
                                        <button onclick="window.deletePost('${post.id}')" 
                                                class="bg-red-500 text-white py-2 px-4 rounded-xl hover:bg-red-600 transition-colors font-medium">
                                            ì‚­ì œ
                                        </button>
                                    ` : `<p class="text-sm text-gray-500">ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`}
                                </div>
                            </div>
                        </div>
                    `;
                    communityMainContent.innerHTML = detailHtml;
                    currentEditingPost = null;

                } else {
                    communityMainContent.innerHTML = `<p class="text-red-500 text-center p-10">í•´ë‹¹ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }

            } catch (error) {
                console.error("ê²Œì‹œë¬¼ ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:", error);
                communityMainContent.innerHTML = `<p class="text-red-500 text-center p-10">ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            }
        }
        
        // 3. ê²Œì‹œë¬¼ ì‘ì„±/ìˆ˜ì • í¼ ì—´ê¸°
        window.openPostForm = function(postDataString = null) {
            let postData = null;
            if (postDataString) {
                try {
                    // ì „ë‹¬ë°›ì€ ë¬¸ìì—´ì„ ê°ì²´ë¡œ ë‹¤ì‹œ íŒŒì‹±
                    postData = JSON.parse(postDataString.replace(/&quot;/g, '"'));
                } catch (e) {
                    console.error("ê²Œì‹œë¬¼ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e);
                    postData = null;
                }
            }
            
            currentEditingPost = postData ? postData.id : null;
            const title = postData ? postData.title : '';
            const content = postData ? postData.content : '';
            const formTitle = postData ? 'ê¸€ ìˆ˜ì •í•˜ê¸°' : 'ìƒˆ ê¸€ ì‘ì„±í•˜ê¸°';
            const buttonText = postData ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì‘ì„± ì™„ë£Œ';

            const formHtml = `
                <div class="p-6 bg-white rounded-xl shadow-xl space-y-4 border-t-4 border-board-color">
                    <h3 class="text-2xl font-bold text-board-color">${formTitle}</h3>
                    
                    <div>
                        <label for="post-title-input" class="block text-sm font-medium text-gray-700 mb-1">ì œëª©:</label>
                        <input type="text" id="post-title-input" value="${title}" 
                               placeholder="ì§ê´€ì ì´ê³  ëˆˆì— ë„ëŠ” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”."
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-board-color focus:border-board-color text-lg font-semibold">
                    </div>
                    
                    <div>
                        <label for="post-content-input" class="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš©:</label>
                        <textarea id="post-content-input" placeholder="ìœ ìš©í•œ ë‹¤ì´ì–´íŠ¸ ì •ë³´ë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”."
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-board-color focus:border-board-color min-h-[300px] text-base leading-relaxed">${content}</textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button onclick="window.renderCommunityView()" 
                                class="bg-gray-400 text-white py-2 px-4 rounded-xl hover:bg-gray-500 transition-colors font-medium">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="window.savePost('${currentEditingPost}')" 
                                class="bg-board-color text-white py-2 px-4 rounded-xl hover:bg-pink-700 transition-colors font-medium">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
            communityMainContent.innerHTML = formHtml;
        }

        // 4. ê²Œì‹œë¬¼ ì €ì¥/ìˆ˜ì • ì²˜ë¦¬
        window.savePost = async function(postId) {
            const titleInput = document.getElementById('post-title-input');
            const contentInput = document.getElementById('post-content-input');
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title || !content) {
                showModal("ì…ë ¥ ì˜¤ë¥˜", "ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", true);
                return;
            }
            
            if (!db || !userId) {
                showModal("ì €ì¥ ì˜¤ë¥˜", "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.", true);
                return;
            }

            try {
                const colRef = window.collection(db, getCommunityCollectionPath());
                let docRef;
                
                const postData = {
                    title: title,
                    content: content,
                    authorId: userId, // í˜„ì¬ ë¡œê·¸ì¸ëœ ê³ ì • IDë¥¼ ì‘ì„±ìë¡œ ì €ì¥
                };

                if (postId && postId !== 'null') {
                    // ìˆ˜ì •
                    docRef = window.doc(colRef, postId);
                    await window.setDoc(docRef, { ...postData, lastModified: new Date().toISOString() }, { merge: true });
                    showModal("ìˆ˜ì • ì™„ë£Œ", "ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", false);
                } else {
                    // ìƒˆë¡œ ì‘ì„±
                    docRef = window.doc(colRef, new Date().getTime().toString()); // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©
                    await window.setDoc(docRef, { ...postData, timestamp: new Date().toISOString() });
                    showModal("ì‘ì„± ì™„ë£Œ", "ìƒˆ ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.", false);
                }

                // ì €ì¥ í›„ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                window.renderCommunityView();

            } catch (error) {
                console.error("ê²Œì‹œë¬¼ ì €ì¥ ì˜¤ë¥˜:", error);
                showModal("ë°ì´í„° ì €ì¥ ì˜¤ë¥˜", `ê²Œì‹œë¬¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
            }
        }
        
        // 5. ê²Œì‹œë¬¼ ì‚­ì œ ì²˜ë¦¬
        window.deletePost = async function(postId) {
            if (!confirm(`ì •ë§ë¡œ ì´ ê²Œì‹œë¬¼(${postId.substring(0, 8)}...)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            if (!db || !userId) {
                showModal("ì‚­ì œ ì˜¤ë¥˜", "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.", true);
                return;
            }

            try {
                // ì‘ì„±ì IDë¥¼ í™•ì¸í•˜ëŠ” ë¡œì§ (ì‚­ì œ ê¶Œí•œ ì²´í¬)
                const docRefCheck = window.doc(db, getCommunityCollectionPath(), postId);
                const docSnapCheck = await window.getDoc(docRefCheck);

                if (docSnapCheck.exists() && docSnapCheck.data().authorId === userId) {
                    const docRef = window.doc(db, getCommunityCollectionPath(), postId);
                    await window.deleteDoc(docRef);
                    showModal("ì‚­ì œ ì™„ë£Œ", "ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", false);
                    window.renderCommunityView();
                } else {
                    showModal("ê¶Œí•œ ì˜¤ë¥˜", "ì´ ê²Œì‹œë¬¼ì€ ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", true);
                }
            } catch (error) {
                console.error("ê²Œì‹œë¬¼ ì‚­ì œ ì˜¤ë¥˜:", error);
                showModal("ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜", `ê²Œì‹œë¬¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
            }
        }


        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™”
        window.onload = function() {
            const today = new Date().toISOString().substring(0, 10);
            mealInput.date.value = today;

            const reportStartDate = document.getElementById('report-start-date');
            const reportEndDate = document.getElementById('report-end-date');
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().substring(0, 10);
            
            if(reportStartDate) reportStartDate.value = firstDayOfMonth;
            if(reportEndDate) reportEndDate.value = today;
            
            mealInput.date.addEventListener('change', (e) => loadMealsForDate(e.target.value));
            mealInput.addButton.addEventListener('click', window.addMeal);
            saveButton.addEventListener('click', saveTodaysMeals);
            
            reportSearchButton.addEventListener('click', window.renderReport);
            selfSearchButton.addEventListener('click', () => {
                friendIdInput.value = ''; 
                window.renderReport();
            });
            
            initializeFirebase();
        };

    </script>
</body>
</html>